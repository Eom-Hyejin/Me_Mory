<!DOCTYPE HTML>
<html lang="ko">
<head>
  <title>Memory</title>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#162060" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="text/html; charset=UTF-8; X-Content-Type-Options=nosniff" http-equiv="Content-Type">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">

  <!-- CSS -->
  <link rel="stylesheet" href="./asset/css/swiper.min.css">
  <link rel="stylesheet" href="./asset/css/base.css">
  <link rel="stylesheet" href="./asset/css/grid.css?a=2">
  <link rel="stylesheet" href="./asset/css/common.css?a=2">
  <link rel="stylesheet" href="./asset/css/layout.css">

  <!-- JS -->
  <script src="./asset/js/jquery-3.3.1.js"></script>
  <script src="./asset/js/swiper.min.js"></script>
  <script src="./asset/js/common.js?a=1"></script>

  <style>
    .is-hidden{display:none!important}
    .btn[disabled]{opacity:.5;pointer-events:none}
    .emotion-title{font-size:18px;margin-top:8px;color:#2d2d2d}
    .result-img{width:164px;height:164px;object-fit:contain}
    .notice{margin-top:12px;color:#666;font-size:14px;line-height:1.4}
    .err{color:#c9302c}
    .ok{color:#2a7c2a;font-weight:700}

    /* 가운데 정렬 */
    .emotion-thumb-box {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
    }
    .is-pc .emotion-thumb-box {
      display: flex;
      justify-content: center;
      width: 100%;
    }
    .is-m .emotion-thumb-box {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* 공통 로그아웃 버튼 스타일 */
    header .header-right .header-user a[data-nav="logout"],
    header .header-right .right-menu .inner ul .header-user-item.ye > a[data-nav="logout"] {
      background-color: #ffcc00 !important;
      color: #fff !important;
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: bold;
      display: block;
      width: fit-content;
      margin-left: auto;
      text-align: center;
    }
    header a[data-nav="logout"]:hover,
    header a[data-nav="logout"]:focus {
      filter: brightness(0.9);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <div class="header-logo">
        <h1><a href="/"><img src="./asset/images/logo.png" alt="Memory"/></a></h1>
      </div>

      <div class="header-cate">
        <ul>
          <li class="active"><a href="#" data-nav="record">감정기록</a></li>
          <li><a href="#" data-nav="calendar">감정캘린더</a></li>
          <li><a href="#" data-nav="around">내 주변 감정</a></li>
          <li><a href="#" data-nav="map">감정지도</a></li>
          <li><a href="#" data-nav="memory">감정회고</a></li>
        </ul>
      </div>

      <div class="header-right">
        <!-- 비로그인 -->
        <div class="right-button header-guest">
          <ul>
            <li class="border"><a href="#" data-nav="login">로그인</a></li>
            <li><a href="#" data-nav="register">회원가입</a></li>
          </ul>
        </div>
        <!-- 로그인 -->
        <div class="right-button header-user is-hidden">
          <ul>
            <li class="border"><a href="#" data-nav="mypage">마이페이지</a></li>
            <li><a href="#" data-nav="logout">로그아웃</a></li>
          </ul>
        </div>

        <div class="right-menu">
          <button type="button" class="menu" onclick="window.activeParent ? activeParent(this, 'right-menu') : void 0;">메뉴바</button>
          <div class="inner">
            <ul>
              <li><a href="#" data-nav="record">감정기록</a></li>
              <li><a href="#" data-nav="calendar">감정캘린더</a></li>
              <li><a href="#" data-nav="around">내 주변 감정</a></li>
              <li><a href="#" data-nav="map">감정지도</a></li>
              <li><a href="#" data-nav="memory">감정회고</a></li>
              <li class="header-user-item is-hidden"><a href="#" data-nav="mypage">마이페이지</a></li>
              <li class="header-user-item is-hidden ye"><a href="#" data-nav="logout">로그아웃</a></li>
              <li class="header-guest-item"><a href="#" data-nav="login">로그인</a></li>
              <li class="header-guest-item"><a href="#" data-nav="register">회원가입</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- 본문 -->
  <section class="py-lg-0">
    <div class="full-box">
      <div class="full-inner full-height">
        <div class="circle-box cate-02">
          <div class="circle-inner">
            <div class="circle-head">
              <div class="is-m mt60">
                <div class="title-box">
                  <h2>오늘의 감정 타임캡슐이<br/>저장되었어요!</h2>
                </div>
              </div>

              <div class="circle-title mb0">
                <div class="inner">
                  <div class="is-pc">
                    <h2 class="md">오늘의 감정 타임캡슐이 <br/>저장되었어요!</h2>
                  </div>

                  <!-- 모바일 상단 미리보기 -->
                  <div class="is-m">
                    <div class="emotion-thumb-box">
                      <img id="emojiTop" class="result-img" src="./asset/images/icon_happy_02.png" alt="">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="circle-body">
              <!-- PC 하단 큰 프리뷰 -->
              <div class="is-pc">
                <div class="emotion-thumb-box">
                  <img id="emojiBottom" class="result-img" src="./asset/images/icon_happy_02.png" alt="">
                </div>
                <p id="saveMsg" class="notice"></p>
              </div>
              <div class="is-m">
                <p id="saveMsgM" class="notice"></p>
              </div>
            </div>

            <div class="circle-foot">
              <div class="button-box">
                <a href="#" id="doneBtn" class="btn btn-active flex-1">완료</a>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 배경 -->
  <div class="bg-box">
    <img src="./asset/images/bg_body_cate_02.png" class="is-pc" alt="">
    <img src="./asset/images/bg_body_cate_02_m.png" class="is-m" alt="">
  </div>

  <!-- (프로젝트에 있다면) 커스텀 스와이퍼 초기화 -->
  <script src="./asset/js/swiper.js?a=1"></script>

  <script>
    /* ========= 기본 설정 ========= */
    const SHOW_STATUS = false; // 상태 문구 숨김

    /* ========= 인증/네비 ========= */
    const getToken = () => localStorage.getItem('accessToken') || '';
    const authHeader = () => {
      const t = getToken();
      if (!t) return '';
      return t.startsWith('Bearer ') ? t : `Bearer ${t}`;
    };
    const isLoggedIn = () => !!getToken();

    function renderHeaderByAuth(){
      const on = isLoggedIn();
      document.querySelectorAll('.header-guest, .header-guest-item').forEach(el=>el.classList.toggle('is-hidden', on));
      document.querySelectorAll('.header-user, .header-user-item').forEach(el=>el.classList.toggle('is-hidden', !on));
    }
    const go = (url)=> window.location.href = url;

    document.addEventListener('click', (e)=> {
      const a = e.target.closest('[data-nav]'); if(!a) return;
      e.preventDefault();
      const k = a.getAttribute('data-nav');
      if(k==='login')    return go('/login_01.html');
      if(k==='register') return go('/register_01.html');
      if(k==='logout'){ localStorage.removeItem('accessToken'); renderHeaderByAuth(); return go('/'); }
      if(k==='mypage')   return isLoggedIn()?go('/mypage_main.html'):go('/login_01.html');
      if(!isLoggedIn())  return go('/login_01.html');
      switch(k){
        case 'record':   return go('/emotion_select_01.html');
        case 'calendar': return go('/emotion_calendar.html');
        case 'map':      return go('/emotion_map.html');
        case 'memory':   return go('/emotion_memory.html');
        case 'around':   return go('/emotion_arround_bluetooth.html');
      }
    });

    /* ========= 이모지/감정 매핑 ========= */
    const EMOJI_SET = {
      joy:     ['icon_happy_02.png','icon_happy_03.png','icon_happy_04.png','icon_happy_05.png','icon_happy_06.png','icon_happy_07.png'],
      sadness: ['icon_sad_02.png','icon_sad_03.png','icon_sad_04.png','icon_sad_05.png','icon_sad_06.png','icon_sad_07.png'],
      anger:   ['icon_angry_02.png','icon_angry_03.png','icon_angry_04.png','icon_angry_05.png','icon_angry_06.png','icon_angry_07.png'],
      worry:   ['icon_uneasy_02.png','icon_uneasy_03.png','icon_uneasy_04.png','icon_uneasy_05.png','icon_uneasy_06.png','icon_uneasy_07.png'],
      proud:   ['icon_envious_02.png','icon_envious_03.png','icon_envious_04.png','icon_envious_05.png','icon_envious_06.png','icon_envious_07.png'],
      upset:   ['icon_upset_02.png','icon_upset_03.png','icon_upset_04.png','icon_upset_05.png','icon_upset_06.png','icon_upset_07.png'],
    };
    const EMOJI_KO = {
      joy:'기쁨', sadness:'슬픔', anger:'분노', worry:'걱정', proud:'뿌듯', upset:'속상'
    };

    function normalizeExprForPreview(expr){
      if (!expr) return 'emoji01';
      if (/^emoji0[1-6]$/.test(String(expr))) return String(expr);
      const n = Number(String(expr).trim());
      if (Number.isInteger(n) && n>=1 && n<=6) return `emoji0${n}`;
      return 'emoji01';
    }
    function getEmojiSrc(emotion_type, expression_type){
      const list = EMOJI_SET[emotion_type] || EMOJI_SET.joy;
      const idx = Math.max(0, Math.min(5, (Number(String(expression_type||'').replace('emoji',''))||1)-1));
      return `./asset/images/${list[idx]}`;
    }

    /* ========= 서버 IO ========= */
    async function fetchServerDraft(id){
      try{
        const r = await fetch(`/api/record-drafts/drafts/${encodeURIComponent(id)}`, {
          headers: { 'Authorization': authHeader() }
        });
        if(r.status === 401 || r.status === 403){
          alert('로그인이 필요합니다.');
          go('/login_01.html');
          return null;
        }
        if(!r.ok) return null;
        return await r.json();
      }catch(e){ return null; }
    }

    async function confirmServerDraft(id){
      return fetch(`/api/record-drafts/drafts/${encodeURIComponent(id)}/confirm`, {
        method:'POST',
        headers:{ 'Authorization': authHeader() }
      });
    }

    /* ========= 상태/DOM ========= */
    const qs = new URLSearchParams(location.search);
    const draftId = qs.get('draftId');

    const emojiTop = document.getElementById('emojiTop');
    const emojiBottom = document.getElementById('emojiBottom');
    const emotionTextTop = document.getElementById('emotionTextTop');
    const emotionTextBottom = document.getElementById('emotionTextBottom');
    const doneBtn = document.getElementById('doneBtn');
    const saveMsg = document.getElementById('saveMsg');
    const saveMsgM = document.getElementById('saveMsgM');

    function setStatusMsg(text, ok=false){
      if (!SHOW_STATUS) return; // 표시 끔
      const html = `<span class="${ok ? 'ok':'err'}">${text}</span>`;
      if (saveMsg) saveMsg.innerHTML = html;
      if (saveMsgM) saveMsgM.innerHTML = html;
    }

    function renderPreview(data){
      const emotion = data?.emotion_type || 'joy';
      const exprPrev = normalizeExprForPreview(data?.expression_type);
      const src = data?.img || getEmojiSrc(emotion, exprPrev);

      if (emojiTop) emojiTop.src = src;
      if (emojiBottom) emojiBottom.src = src;

      const label = EMOJI_KO[emotion] || emotion;
      const deg = String(exprPrev).replace('emoji',''); // 01~06
      const txt = `${label} (표현 ${deg})`;
      if (emotionTextTop) emotionTextTop.textContent = txt;
      if (emotionTextBottom) emotionTextBottom.textContent = txt;
    }

    /* ========= 완료 버튼에서만 저장 ========= */
    async function handleDoneClick(e){
      e.preventDefault();
      if (!isLoggedIn()){
        alert('로그인이 필요합니다.');
        return go('/login_01.html');
      }
      if (!draftId){
        // draftId 없으면 서버가 무엇을 확정해야 할지 모름
        alert('임시 기록(draftId)을 찾지 못했어요. 기록 작성 화면으로 돌아갑니다.');
        return go('/emotion_select_01.html');
      }

      try{
        doneBtn.setAttribute('disabled', 'disabled');
        doneBtn.textContent = '저장 중…';

        const r = await confirmServerDraft(draftId);
        if (r.status === 401 || r.status === 403){
          alert('로그인 세션이 만료되었어요. 다시 로그인해 주세요.');
          return go('/login_01.html');
        }
        if (!r.ok){
          let msg = `저장 실패 (HTTP ${r.status})`;
          try{
            const t = await r.json();
            if (t && t.message) msg = t.message;
          }catch(_){}
          alert(msg);
          doneBtn.removeAttribute('disabled');
          doneBtn.textContent = '완료';
          return;
        }

        // 성공 → 캘린더 이동
        go('/emotion_calendar.html');
      }catch(err){
        alert('네트워크 오류로 저장하지 못했어요. 다시 시도해 주세요.');
        doneBtn.removeAttribute('disabled');
        doneBtn.textContent = '완료';
      }
    }

    /* ========= 초기화 ========= */
    async function init(){
      renderHeaderByAuth();

      if(!isLoggedIn()){
        alert('로그인이 필요합니다.');
        go('/login_01.html');
        return;
      }

      // 미리보기용 데이터 불러오기 (저장은 하지 않음)
      let data = null;
      if(draftId){
        data = await fetchServerDraft(draftId);
        if(!data){
          try{ data = JSON.parse(localStorage.getItem('recordDraft.temp')||'{}'); }catch(e){ data = {}; }
        }
      }else{
        try{ data = JSON.parse(localStorage.getItem('recordDraft.temp')||'{}'); }catch(e){ data = {}; }
      }
      if(!data || typeof data !== 'object') data = {};
      if(!data.emotion_type) data.emotion_type = 'joy';
      renderPreview(data);

      // 완료 버튼에서만 확정 저장
      doneBtn?.addEventListener('click', handleDoneClick);

      // 토큰 변경 시 헤더 갱신
      window.addEventListener('storage', (ev)=> {
        if(ev.key === 'accessToken'){ renderHeaderByAuth(); }
      });
    }

    if (typeof window.activeParent !== 'function') {
      window.activeParent = function(){};
    }

    init();
  </script>
</body>
</html>