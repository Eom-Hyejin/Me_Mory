<!DOCTYPE HTML>
<html lang="ko">
<head>
  <title>Memory</title>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="text/html; charset=UTF-8; X-Content-Type-Options=nosniff" http-equiv="Content-Type">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
  <meta name="theme-color" content="#162060" />
  <meta property="og:image" content="./asset/images/layout/img_thumbnail.png">

  <!-- CSS -->
  <link rel="stylesheet" href="./asset/css/swiper.min.css">
  <link rel="stylesheet" href="./asset/css/base.css">
  <link rel="stylesheet" href="./asset/css/grid.css?a=2">
  <link rel="stylesheet" href="./asset/css/common.css?a=1">
  <link rel="stylesheet" href="./asset/css/layout.css">
</head>
<body>
  <!-- Header (공통 네비게이션: header.js가 제어) -->
  <header>
    <div class="container">
      <div class="header-logo">
        <h1><a href="/"><img src="./asset/images/logo.png" alt="Me:mory"></a></h1>
      </div>
      <div class="header-cate">
        <ul>
          <li><a href="#" data-nav="record">감정기록</a></li>
          <li><a href="#" data-nav="calendar">감정캘린더</a></li>
          <li><a href="#" data-nav="around">내 주변 감정</a></li>
          <li><a href="#" data-nav="map">감정지도</a></li>
          <li><a href="#" data-nav="memory">감정회고</a></li>
        </ul>
      </div>
      <div class="header-right">
        <div class="right-button">
          <ul>
            <li class="border"><a href="#" data-nav="login">로그인</a></li>
            <li><a href="#" data-nav="register">회원가입</a></li>
          </ul>
        </div>
        <div class="right-menu">
          <button type="button" class="menu" onclick="activeParent(this, 'right-menu');">메뉴바</button>
          <div class="inner">
            <ul>
              <li><a href="#" data-nav="record">감정기록</a></li>
              <li><a href="#" data-nav="calendar">감정캘린더</a></li>
              <li><a href="#" data-nav="around">내 주변 감정</a></li>
              <li><a href="#" data-nav="map">감정지도</a></li>
              <li><a href="#" data-nav="memory">감정회고</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Body -->
  <section>
    <div class="container container-xl">
      <div class="title-box">
        <h2>회원가입</h2>
      </div>

      <!-- 기본 회원 정보 -->
      <div class="inner-box">
        <div class="title-box md">
          <h3>기본 회원 정보</h3>
        </div>

        <div class="write-box">
          <ul>
            <!-- 아이디 -->
            <li>
              <strong class="req">아이디</strong>
              <div>
                <div class="flex flex-vc">
                  <div class="input-box input-lg flex-1">
                    <input id="userId" type="text" placeholder="아이디를 입력해주세요" autocomplete="username"/>
                  </div>
                  <div class="button-box ml8">
                    <a id="btnCheckId" href="#" class="btn btn-gray-outline btn-lg">아이디 중복체크</a>
                  </div>
                </div>
                <div class="message-box">
                  <p id="msgId" class=""></p>
                </div>
              </div>
            </li>

            <!-- 비밀번호 -->
            <li>
              <strong class="req">비밀번호</strong>
              <div>
                <div class="input-box input-lg">
                  <input id="password" type="password" placeholder="8~16자의 영문 대/소문자, 숫자, 특수문자를 사용해주세요" autocomplete="new-password"/>
                  <button type="button" class="password" onclick="togglePw('password')">비밀번호 보임 및 숨김 처리</button>
                </div>
                <div class="message-box">
                  <p id="msgPw" class=""></p>
                </div>
              </div>
            </li>

            <!-- 비밀번호 확인 -->
            <li>
              <strong class="req">비밀번호 확인</strong>
              <div>
                <div class="input-box input-lg">
                  <input id="password2" type="password" placeholder="비밀번호를 재입력해 주세요" autocomplete="new-password"/>
                  <button type="button" class="password" onclick="togglePw('password2')">비밀번호 보임 및 숨김 처리</button>
                </div>
                <div class="message-box">
                  <p id="msgPw2" class=""></p>
                </div>
              </div>
            </li>

            <!-- 이름 -->
            <li>
              <strong class="req">이름</strong>
              <div>
                <div class="input-box input-lg">
                  <input id="name" type="text" placeholder="실명을 입력해 주세요" autocomplete="name"/>
                </div>
              </div>
            </li>

            <!-- 이메일 -->
            <li>
              <strong class="req">이메일</strong>
              <div>
                <div class="input-box input-lg">
                  <input id="email" type="text" placeholder="이메일 주소를 입력해 주세요" autocomplete="email"/>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <!-- 약관 -->
      <div class="inner-box mt24 mt-lg-16">
        <div class="check-total-box">
          <div class="total-head">
            <input type="checkbox" id="allAgree"/>
            <label for="allAgree">전체동의 <small>(모든 사항을 확인하고 전체 동의합니다.)</small></label>
          </div>

          <div class="total-body">
            <ul>
              <!-- (필수) 서비스 이용약관 -->
              <li>
                <div class="list-head">
                  <input type="checkbox" id="agree1" class="agree-required"/>
                  <label for="agree1"><b>(필수)</b> 서비스 이용약관 동의</label>
                </div>
                <div class="list-body">
                  <div class="inner">
                    <p>
                      본 약관은 회원(이하 “이용자”)이 회사가 제공하는 서비스를 이용함에 있어 회사와 이용자의 권리·의무 및 책임사항, 이용조건과 절차 등 기본적인 사항을 규정합니다.
                    </p>
                    <p>
                      1) 약관의 효력 및 변경: 회사는 관련 법령을 준수하여 본 약관을 변경할 수 있으며, 변경 내용은 시행 7일 전(중요한 사항의 경우 30일 전) 공지합니다. 변경에 동의하지 않는 이용자는 회원 탈퇴로 의사표시를 할 수 있습니다.
                    </p>
                    <p>
                      2) 회원가입 및 관리: 이용자는 사실과 일치하는 정보를 제공해야 하며, 타인의 정보를 도용할 수 없습니다. 회원 자격이 상실되거나 제한되는 경우 회사는 사유를 고지합니다.
                    </p>
                    <p>
                      3) 서비스 이용: 이용자는 법령 및 본 약관을 준수해야 하며, 타인의 권리를 침해하거나 서비스 운영을 방해하는 행위를 해서는 안 됩니다. 회사는 안정적인 서비스 제공을 위해 시스템 점검을 실시할 수 있습니다.
                    </p>
                    <p>
                      4) 콘텐츠 및 지식재산권: 서비스 내 제공되는 일체의 콘텐츠와 자료에 대한 권리는 회사 또는 정당한 권리자에게 있으며, 무단 복제·배포·개작을 금지합니다.
                    </p>
                    <p>
                      5) 책임 제한: 천재지변, 불가항력, 이용자 귀책 사유 등으로 인한 서비스 장애에 대해 회사는 책임을 지지 않습니다. 회사는 관련 법령이 허용하는 범위 내에서 손해배상 책임을 제한할 수 있습니다.
                    </p>
                    <p>
                      6) 준거법 및 분쟁해결: 본 약관은 대한민국 법령에 따르며, 분쟁이 발생한 경우 민사소송법상 관할 법원을 전속 관할로 합니다.
                    </p>
                  </div>
                </div>
              </li>

              <!-- (필수) 개인정보 수집·이용 동의 -->
              <li>
                <div class="list-head">
                  <input type="checkbox" id="agree2" class="agree-required"/>
                  <label for="agree2"><b>(필수)</b> 개인정보 수집·이용 동의</label>
                </div>
                <div class="list-body">
                  <div class="inner">
                    <p><b>1) 수집 항목</b><br/>
                      - 필수: 아이디, 비밀번호, 이름, 이메일, 서비스 이용 기록(접속 일시, 접속 로그, 쿠키), 기기 정보(브라우저/OS 정보 등)
                    </p>
                    <p><b>2) 수집·이용 목적</b><br/>
                      - 회원 가입 및 본인 확인, 서비스 제공 및 유지·관리, 문의/민원 처리, 보안/부정 이용 방지, 고지·통지 및 분쟁 처리
                    </p>
                    <p><b>3) 보유 및 이용 기간</b><br/>
                      - 회원 탈퇴 시까지 보유 후 지체 없이 파기합니다. 다만 관계 법령에 따라 아래 기간 동안 보관할 수 있습니다.<br/>
                      · 표시·광고에 관한 기록: 6개월<br/>
                      · 계약 또는 청약철회, 대금결제 및 재화 등의 공급에 관한 기록: 5년<br/>
                      · 소비자 불만 또는 분쟁처리에 관한 기록: 3년<br/>
                      · 접속에 관한 로그 기록: 3개월
                    </p>
                    <p><b>4) 동의 거부 권리 및 불이익</b><br/>
                      - 이용자는 개인정보 수집·이용에 대한 동의를 거부할 권리가 있으나, 필수 항목 동의 거부 시 회원가입 및 서비스 이용이 제한될 수 있습니다.
                    </p>
                    <p><b>5) 기타</b><br/>
                      - 보다 상세한 내용은 개인정보처리방침(버전: <span id="privacyVerText"></span>)에서 확인하실 수 있습니다.
                    </p>
                  </div>
                </div>
              </li>
            </ul>
          </div>

        </div>
      </div>

      <!-- 버튼 -->
      <div class="button-box mt40 mt-lg-32">
        <div class="w280 flex-md-1 mr12 mr-lg-8">
          <a href="/" id="btnCancel" class="btn btn-gray-outline ft-white">취소</a>
        </div>
        <div class="w280 flex-md-1">
          <a href="#" id="btnSubmit" class="btn btn-active">입력완료</a>
        </div>
      </div>
    </div>
  </section>

  <!-- BG -->
  <div class="bg-box">
    <img src="./asset/images/bg_body_member.png" class="is-pc" loading="lazy" alt="">
    <img src="./asset/images/bg_body_member_m.png" class="is-m" loading="lazy" alt="">
  </div>

  <!-- Scripts -->
  <script src="./asset/js/swiper.js?a=1" defer></script>
  <script src="/asset/js/app.js?ver=27" defer></script>
  <!-- 공통 헤더 스크립트 (세션검증/네비게이션) -->
  <script src="/asset/js/header.js?v=1" defer></script>

  <!-- 이 페이지 전용 로직 -->
  <script>
  // ===== 약관 버전 (백엔드 .env와 맞추세요) =====
  const TOS_VERSION = window.APP_TOS_VERSION || '1.0.0';
  const PRIVACY_VERSION = window.APP_PRIVACY_VERSION || '1.0.0';

  // 페이지에 버전 텍스트 노출(선택)
  document.addEventListener('DOMContentLoaded', () => {
    const el = document.getElementById('privacyVerText');
    if (el) el.textContent = PRIVACY_VERSION;
  });

  // ===== 유틸 =====
  const $ = (sel) => document.querySelector(sel);
  const idOk  = { value: false };   // 아이디 중복체크 완료 여부
  const pwOk  = { value: false };
  const pw2Ok = { value: false };

  function setMsg(el, text, ok) {
    el.textContent = text || '';
    if (!text) { el.className = ''; return; }
    el.className = ok ? 'ft-green' : 'ft-red';
  }

  function togglePw(id) {
    const input = document.getElementById(id);
    input.type = (input.type === 'password') ? 'text' : 'password';
  }

  // ===== 입력 참조 =====
  const ipId   = $('#userId');
  const ipPw   = $('#password');
  const ipPw2  = $('#password2');
  const ipName = $('#name');
  const ipEmail= $('#email');

  const msgId  = $('#msgId');
  const msgPw  = $('#msgPw');
  const msgPw2 = $('#msgPw2');

  // ===== 아이디 규칙 & 중복체크 =====
  const idRegex = /^[a-zA-Z0-9._-]{4,20}$/; // 백엔드 USERNAME_POLICY에 맞춤

  ipId.addEventListener('input', () => {
    idOk.value = false; // 값 바뀌면 다시 중복체크 필요
    if (!ipId.value) { setMsg(msgId, '아이디를 입력해주세요.', false); return; }
    if (!idRegex.test(ipId.value)) {
      setMsg(msgId, '아이디 형식이 올바르지 않습니다(영문/숫자/._-, 4~20자).', false);
      return;
    }
    setMsg(msgId, '아이디 형식이 올바릅니다. 중복체크를 진행해주세요.', true);
  });

  $('#btnCheckId').addEventListener('click', async (e) => {
    e.preventDefault();
    const username = ipId.value.trim();
    if (!idRegex.test(username)) {
      setMsg(msgId, '아이디 형식이 올바르지 않습니다(영문/숫자/._-, 4~20자).', false);
      return;
    }
    try {
      // 백엔드: POST /api/auth/username  { username }
      const res = await fetch('/api/auth/username', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
      });
      if (res.status === 200) {
        idOk.value = true;
        setMsg(msgId, '사용할 수 있는 아이디입니다.', true);
      } else if (res.status === 409) {
        idOk.value = false;
        setMsg(msgId, '사용할 수 없는 아이디입니다.', false);
      } else {
        const err = await res.json().catch(()=>({}));
        throw new Error(err.message || '중복체크 실패');
      }
    } catch (err) {
      idOk.value = false;
      setMsg(msgId, '중복체크 중 오류가 발생했습니다.', false);
    }
  });

  // ===== 비밀번호 규칙 =====
  const pwRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[^\w\s]).{8,16}$/; // 백엔드 PW_POLICY와 동일
  ipPw.addEventListener('input', () => {
    const v = ipPw.value;
    if (!v) { setMsg(msgPw, '', false); pwOk.value = false; checkPw2(); return; }
    if (!pwRegex.test(v)) {
      setMsg(msgPw, '비밀번호 형식을 확인해주세요.', false);
      pwOk.value = false;
    } else {
      setMsg(msgPw, '사용가능한 비밀번호입니다.', true);
      pwOk.value = true;
    }
    checkPw2();
  });

  function checkPw2() {
    const v1 = ipPw.value, v2 = ipPw2.value;
    if (!v2) { setMsg(msgPw2, '', false); pw2Ok.value = false; return; }
    if (v1 && v1 === v2) {
      setMsg(msgPw2, '비밀번호가 일치합니다.', true);
      pw2Ok.value = true;
    } else {
      setMsg(msgPw2, '비밀번호가 일치하지 않습니다.', false);
      pw2Ok.value = false;
    }
  }
  ipPw2.addEventListener('input', checkPw2);

  // ===== 이메일 간단 검증 =====
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  // ===== 약관 전체동의 =====
  const allAgree = $('#allAgree');
  const agreeReq = document.querySelectorAll('.agree-required');

  allAgree.addEventListener('change', () => {
    agreeReq.forEach(cb => cb.checked = allAgree.checked);
  });
  agreeReq.forEach(cb => {
    cb.addEventListener('change', () => {
      allAgree.checked = Array.from(agreeReq).every(x => x.checked);
    });
  });

  // ===== 버튼 액션 =====
  $('#btnSubmit').addEventListener('click', async (e) => {
    e.preventDefault();

    // 필수값 체크 (휴대폰 없이)
    const username = ipId.value.trim();
    const password = ipPw.value;
    const password2= ipPw2.value;
    const name     = ipName.value.trim();
    const email    = ipEmail.value.trim();

    if (!username || !password || !password2 || !name || !email) {
      alert('회원가입이 불가능합니다.\n(필수 항목을 모두 입력해주세요)');
      return;
    }
    if (!idOk.value)   return alert('회원가입이 불가능합니다.\n(아이디 중복체크를 완료해주세요)');
    if (!pwOk.value)   return alert('회원가입이 불가능합니다.\n(비밀번호 형식을 확인해주세요)');
    if (!pw2Ok.value)  return alert('회원가입이 불가능합니다.\n(비밀번호가 일치하지 않습니다)');
    if (!emailRegex.test(email)) {
      alert('회원가입이 불가능합니다.\n(이메일 형식을 확인해주세요)');
      return;
    }
    if (!Array.from(agreeReq).every(x => x.checked)) {
      alert('회원가입이 불가능합니다.\n(필수 약관에 동의해주세요)');
      return;
    }

    try {
      // 실제 회원가입 API 호출 (POST /api/auth)
      const res = await fetch('/api/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email,
          username,
          password,
          name,
          consents: {
            tosVersion: TOS_VERSION,
            privacyVersion: PRIVACY_VERSION,
            marketingOptIn: false
          }
        })
      });

      if (!res.ok) {
        const err = await res.json().catch(()=>({}));
        throw new Error(err.message || '회원가입 실패');
      }

      const data = await res.json();
      if (data?.token)        localStorage.setItem('accessToken', data.token);
      if (data?.refreshToken) localStorage.setItem('refreshToken', data.refreshToken);

      alert('회원가입이 완료되었습니다.');
      window.location.href = '/register_02.html';
    } catch (err) {
      alert('회원가입 처리 중 오류가 발생했습니다.\n' + (err.message || 'Unknown error'));
    }
  });
  </script>
</body>
</html>