<!DOCTYPE HTML>
<html lang="ko">
<head>
  <title>Memory</title>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#162060" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="text/html; charset=UTF-8; X-Content-Type-Options=nosniff" http-equiv="Content-Type">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">

  <!-- CSS -->
  <link rel="stylesheet" href="./asset/css/swiper.min.css">
  <link rel="stylesheet" href="./asset/css/base.css">
  <link rel="stylesheet" href="./asset/css/grid.css?a=2">
  <link rel="stylesheet" href="./asset/css/common.css?a=2">
  <link rel="stylesheet" href="./asset/css/layout.css">

  <!-- JS (공용) -->
  <script src="./asset/js/jquery-3.3.1.js"></script>
  <script src="./asset/js/swiper.min.js"></script>
  <script src="./asset/js/common.js?a=2"></script>

  <style>
    .is-hidden{display:none!important}
    header .header-right .header-user a[data-nav="logout"],
    header .header-right .right-menu .inner ul .header-user-item.ye > a[data-nav="logout"]{
      background:#ffcc00!important;color:#fff!important;padding:8px 14px;border-radius:6px;font-weight:bold;display:block;width:fit-content;margin-left:auto;text-align:center}
    header a[data-nav="logout"]:hover, header a[data-nav="logout"]:focus{filter:brightness(.9)}
    #profile-img{object-fit:cover;border-radius:50%}
    .is-disabled{pointer-events:none;opacity:.6}

    .comment-empty{ padding:24px 12px; color:#9aa; text-align:center; }
    .image-thumb-box{ width:88px; height:88px; background-size:cover; background-position:center; border-radius:10px; display:none; }
    .image-thumb-box.has-img{ display:block; }
    .chat-box textarea{ max-height:30vh; }

    /* 댓글 본문 강제 노출(테마 충돌 방지) */
    .reply-body{ display:block !important; max-height:none !important; overflow:visible !important; padding:8px 0 !important; }
    .reply-body p.ctext{
      display:block !important; opacity:1 !important; visibility:visible !important; height:auto !important;
      max-height:none !important; overflow:visible !important; white-space:normal !important;
      line-height:1.6 !important; font-size:14px !important; color:#fff !important; margin:0 !important;
    }

    /* 모달 보정 */
    #modal-view[aria-hidden="true"]{ display:none; }
    #modal-view[aria-hidden="false"]{ display:block; }
    #modal-view .emotion-view-box .image li{
      width:88px; height:88px; background-size:cover; background-position:center; border-radius:10px;
    }
  </style>
</head>
<body>
<!-- ========== 통일된 헤더 ========== -->
<header>
  <div class="container">
    <div class="header-logo">
      <h1><a href="/"><img src="./asset/images/logo.png" alt="Memory"/></a></h1>
    </div>

    <div class="header-cate">
      <ul>
        <li><a href="#" data-nav="record">감정기록</a></li>
        <li><a href="#" data-nav="calendar">감정캘린더</a></li>
        <li class="active"><a href="#" data-nav="around">내 주변 감정</a></li>
        <li><a href="#" data-nav="map">감정지도</a></li>
        <li><a href="#" data-nav="memory">감정회고</a></li>
      </ul>
    </div>

    <div class="header-right">
      <!-- 게스트 -->
      <div class="right-button header-guest">
        <ul>
          <li class="border"><a href="#" data-nav="login">로그인</a></li>
          <li><a href="#" data-nav="register">회원가입</a></li>
        </ul>
      </div>

      <!-- 로그인 -->
      <div class="right-button header-user is-hidden">
        <ul>
          <li class="border"><a href="#" data-nav="mypage">마이페이지</a></li>
          <!-- id="logoutBtn" 부여 (스크립트에서 사용) -->
          <li><a href="#" id="logoutBtn" data-nav="logout">로그아웃</a></li>
        </ul>
      </div>

      <div class="right-menu">
        <button type="button" class="menu" onclick="activeParent(this, 'right-menu');">메뉴바</button>
        <div class="inner">
          <ul>
            <li><a href="#" data-nav="record">감정기록</a></li>
            <li><a href="#" data-nav="calendar">감정캘린더</a></li>
            <li><a href="#" data-nav="around">내 주변 감정</a></li>
            <li><a href="#" data-nav="map">감정지도</a></li>
            <li><a href="#" data-nav="memory">감정회고</a></li>

            <!-- 로그인 상태 메뉴 -->
            <li class="header-user-item is-hidden"><a href="#" data-nav="mypage">마이페이지</a></li>
            <li class="header-user-item is-hidden ye"><a href="#" data-nav="logout">로그아웃</a></li>

            <!-- 게스트 상태 메뉴 -->
            <li class="header-guest-item"><a href="#" data-nav="login">로그인</a></li>
            <li class="header-guest-item"><a href="#" data-nav="register">회원가입</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<section>
  <div class="container container-xxl">
    <div class="title-box flex flex-vc" id="titleBar">
      <a href="javascript:history.back();" class="back">이전</a>
      <img id="titleUserImg" src="./asset/images/img_arround_thumb_02.png" alt="">
      <h2 class="f32 f-lg-18" id="titleText">오늘 감정 캡슐</h2>
    </div>

    <!-- 레코드 1건(상단 카드) -->
    <div class="comment-box" id="recordCard" style="display:none">
      <ul>
        <li>
          <a href="javascript:;" class="list-head" id="openModalBtn">
            <div class="list-head-left">
              <div class="emotion-thumb-box sm">
                <img id="cardEmoji" src="./asset/images/icon_happy_02.png" alt="">
              </div>
              <time id="cardDate">-</time>
            </div>
            <div class="list-head-right">
              <div class="right-text">
                <strong id="cardEmotion">-</strong>
                <p class="subject" id="cardTitle">-</p>
                <p class="location" id="cardPlace">-</p>
              </div>
              <div class="right-more">
                <div class="image-thumb-box" id="cardThumb"></div>
              </div>
            </div>
            <div class="list-head-mobile">
              <p class="subject" id="cardTitleM">-</p>
              <p class="location" id="cardPlaceM">-</p>
            </div>
          </a>
          <div class="list-body">
            <ul id="commentList"><!-- JS --></ul>
            <div class="comment-empty is-hidden" id="emptyComments">아직 댓글이 없어요. 첫 댓글을 남겨보세요!</div>
          </div>
        </li>
      </ul>
    </div>

    <!-- 페이지네이션 -->
    <div class="paging-box" id="paging" style="display:none">
      <ul id="pagingUl"><!-- JS --></ul>
    </div>
  </div>
</section>

<!-- 하단 댓글 입력 -->
<div class="chat-box">
  <div class="container container-xxl">
    <div class="inner">
      <textarea id="commentInput" placeholder="댓글을 남겨주세요"></textarea>
      <button type="button" class="submit" id="commentSubmit">등록</button>
    </div>
  </div>
</div>

<!-- 배경 -->
<div class="bg-box">
  <img src="./asset/images/bg_body_around.png" class="is-pc" alt="">
  <img src="./asset/images/bg_body_around_m.png" class="is-m" alt="">
</div>

<!-- 상세 모달 (캘린더와 동일 패턴) -->
<div class="modal-box" id="modal-view" role="dialog" aria-modal="true" aria-hidden="true" inert>
  <div class="box">
    <div class="modal-head">
      <h2 id="modalTitle">감정기록</h2>
      <a href="javascript:;" class="close" onclick="try{window.modalClose && window.modalClose(this)}catch(_){hideModal()}">닫기</a>
    </div>
    <div class="modal-body">
      <div class="emotion-view-box"><!-- JS 렌더 --></div>
    </div>
    <div class="modal-foot">
      <div class="button-box">
        <a href="javascript:;" onclick="try{window.modalClose && window.modalClose(this)}catch(_){hideModal()}" class="btn btn-active btn-lg">확인</a>
      </div>
    </div>
  </div>
</div>

<!-- 공용 확인 모달 (신고/삭제용) -->
<div class="modal-box modal-sm" id="modal-common" role="dialog" aria-modal="true" aria-hidden="true" inert>
  <div class="box">
    <div class="modal-head">
      <h2 id="cmModalTitle">알림</h2>
      <a href="javascript:;" class="close" onclick="try{modalClose(this)}catch(_){hideCmModal()}">닫기</a>
    </div>
    <div class="modal-body">
      <p id="cmModalMsg">처리가 완료되었습니다.</p>
    </div>
    <div class="modal-foot">
      <div class="button-box" id="cmModalButtons">
        <a href="javascript:;" class="btn btn-active btn-lg flex-lg-1" id="cmModalOk">확인</a>
      </div>
    </div>
  </div>
</div>

<!-- 앱 전용 JS (중복 로드 금지) -->
<script src="/asset/js/app.js?ver=25"></script>

<script>
/* ========== 공통 ========== */
const DEV = false;
const isLoggedIn = () => !!localStorage.getItem('accessToken');
const go = (url) => (location.href = url);
function redirectToLogin(){ const back = encodeURIComponent(location.pathname + location.search); location.href = `/login_01.html?next=${back}`; }

function renderHeaderByAuthLocal(){
  const loggedIn = isLoggedIn();
  document.querySelectorAll('.header-guest, .header-guest-item').forEach(el=>el.classList.toggle('is-hidden', loggedIn));
  document.querySelectorAll('.header-user, .header-user-item').forEach(el=>el.classList.toggle('is-hidden', !loggedIn));
}

/* ★ 토큰 정규화 & 만료 체크 */
function getRawToken(){
  let t = localStorage.getItem('accessToken') || '';
  t = String(t).trim();
  if ((t.startsWith('"') && t.endsWith('"')) || (t.startsWith("'") && t.endsWith("'"))) t = t.slice(1,-1).trim();
  t = decodeURIComponent(t.replace(/\+/g,'%20')).trim();
  t = t.replace(/^bearer\s+/i,'').trim();
  t = t.split(/\s+/)[0];
  const m = t.match(/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+/);
  return m ? m[0] : '';
}
function jwtExp(){
  try{
    const raw = getRawToken();
    if (!raw) return 0;
    const payload = JSON.parse(atob(raw.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
    return Number(payload.exp || 0);
  }catch{ return 0; }
}
function isExpired(skewSec=20){
  const exp = jwtExp();
  if (!exp) return false;
  const now = Math.floor(Date.now()/1000);
  return exp - now <= skewSec;
}

/* 인증된 fetch 변형 재시도 */
async function fetchWithAuthVariants(url, optionsBase={}){
  const token = getRawToken();
  if (!token) throw Object.assign(new Error('NO_TOKEN'), { code:'NO_TOKEN' });

  const headersCommon = { 'Content-Type':'application/json', ...(optionsBase.headers||{}) };
  const trials = [
    { 'Authorization': `Bearer ${token}` },
    { 'Authorization': token },
    { 'x-access-token': token },
    { 'access-token': token },
  ];
  for (let i=0;i<trials.length;i++){
    const headers = { ...headersCommon, ...trials[i] };
    if (DEV) console.log('[auth trial]', i+1, headers);
    const res = await fetch(url, { ...optionsBase, headers });
    if (res.ok) return res;
    if (res.status !== 401 || i === trials.length-1) return res;
  }
}

/* /api/auth/me 프리체크 */
async function precheckAuth(){
  try{
    const token = getRawToken();
    if (!token || isExpired()) return false;
    const r = await fetch('/api/auth/me', { headers:{ Authorization:`Bearer ${token}` } });
    return r.ok;
  }catch{ return false; }
}

/* 네비게이션 (헤더·사이드 메뉴 공통) */
document.addEventListener('click', (e) => {
  const a = e.target.closest('[data-nav]'); if (!a) return;
  e.preventDefault();
  const key = a.getAttribute('data-nav');
  if (key === 'login') return go('/login_01.html');
  if (key === 'register') return go('/register_01.html');
  if (key === 'logout'){ localStorage.removeItem('accessToken'); (window.renderHeaderByAuth||renderHeaderByAuthLocal)(); return go('/'); }
  if (key === 'mypage') return isLoggedIn() ? go('/mypage_main.html') : go('/login_01.html');
  if (!isLoggedIn()) return go('/login_01.html');
  switch (key){
    case 'record': return go('/emotion_select_01.html');
    case 'calendar': return go('/emotion_calendar.html');
    case 'map': return go('/emotion_map.html');
    case 'memory': return go('/emotion_memory.html');
    case 'around': return go('/emotion_arround_bluetooth.html');
  }
});

/* ===== 안전 fetch (401/403 시 로그인 리다이렉트 옵션) ===== */
const authHeader = () => {
  const raw = localStorage.getItem('accessToken') || '';
  const t = String(raw).trim();
  if (!t) return {};
  return { Authorization: /^Bearer\s/i.test(t) ? t : `Bearer ${t}` };
};
async function safeFetch(url, init = {}, opts = {}) {
  const { redirectOnAuth = true } = opts;
  const r = await fetch(url, { ...init, headers: { ...(init.headers||{}), ...authHeader() } });
  if ([401,403,419].includes(r.status)) {
    if (redirectOnAuth) {
      try { localStorage.removeItem('accessToken'); } catch(_) {}
      location.href = '/login_01.html';
    }
  }
  return r;
}

/* ===== 유틸/상태 ===== */
const EMOJI_SET = {
  joy:['icon_happy_02.png','icon_happy_03.png','icon_happy_04.png','icon_happy_05.png','icon_happy_06.png','icon_happy_07.png'],
  sadness:['icon_sad_02.png','icon_sad_03.png','icon_sad_04.png','icon_sad_05.png','icon_sad_06.png','icon_sad_07.png'],
  anger:['icon_angry_02.png','icon_angry_03.png','icon_angry_04.png','icon_angry_05.png','icon_angry_06.png','icon_angry_07.png'],
  worry:['icon_uneasy_02.png','icon_uneasy_03.png','icon_uneasy_04.png','icon_uneasy_05.png','icon_uneasy_06.png','icon_uneasy_07.png'],
  proud:['icon_envious_02.png','icon_envious_03.png','icon_envious_04.png','icon_envious_05.png','icon_envious_06.png','icon_envious_07.png'],
  upset:['icon_upset_02.png','icon_upset_03.png','icon_upset_04.png','icon_upset_05.png','icon_upset_06.png','icon_upset_07.png'],
};
const EMOJI_LABEL = { joy:'행복해요', sadness:'슬퍼요', anger:'화나요', worry:'불안해요', proud:'부러워요', upset:'속상해요' };

function parseExprIndex(expression_type){
  const m = String(expression_type||'').match(/(\d+)/);
  let n = m ? parseInt(m[1],10) : 2;
  if (!Number.isFinite(n)) n = 2;
  return Math.max(1, Math.min(6, n)) - 1;
}
function getEmojiSrc(emotion_type, expression_type){
  const list = EMOJI_SET[String(emotion_type)] || EMOJI_SET.joy;
  const idx = parseExprIndex(expression_type);
  return `./asset/images/${list[idx]}`;
}

let __ME = null;
let __REC = null;
let __REC_VIS = 'public';
let PAGING = { page:1, size:20, total:0 };

function toggleCommentInput(show){
  const box = document.querySelector('.chat-box');
  if (box) box.style.display = show ? '' : 'none';
}

/* ===== 타이틀/카드 렌더 ===== */
function setTitle(userImg, userName){
  document.getElementById('titleUserImg').src = userImg || './asset/images/img_arround_thumb_02.png';
  const text = userName ? `${userName}의 오늘 감정 캡슐` : '오늘 감정 캡슐';
  document.getElementById('titleText').textContent = text;
}
function fmtDate(iso){
  try{
    const d = new Date(iso);
    const mm = d.getMonth()+1, dd=d.getDate();
    const yo = d.toLocaleDateString('ko-KR', { weekday:'short' });
    return `${mm}월 ${dd}일(${yo})`;
  }catch(_){ return '-'; }
}
function renderRecordCard(rec, images){
  const card = document.getElementById('recordCard');
  card.style.display='block';
  document.getElementById('cardEmoji').src = getEmojiSrc(rec.emotion_type, rec.expression_type);
  document.getElementById('cardDate').textContent = fmtDate(rec.created_at);
  const ko = EMOJI_LABEL[rec.emotion_type] || '감정';
  document.getElementById('cardEmotion').textContent = ko;
  const titleText = rec.title || (rec.content ? String(rec.content).slice(0,40) : '-');
  document.getElementById('cardTitle').textContent = titleText;
  document.getElementById('cardTitleM').textContent = titleText;
  document.getElementById('cardPlace').textContent = rec.place || '';
  document.getElementById('cardPlaceM').textContent = rec.place || '';

  const thumb = images && images[0] ? images[0] : (rec.representative_img || rec.img || '');
  const box = document.getElementById('cardThumb');
  if (thumb){
    box.style.backgroundImage = `url('${thumb}')`;
    box.classList.add('has-img');
  } else {
    box.style.backgroundImage = '';
    box.classList.remove('has-img');
  }
}

/* ===== 댓글 렌더 ===== */
function escapeHTML(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function normalizeCommentText(c){
  const raw = c.content ?? c.comment ?? c.message ?? c.text ?? c.body ?? c.description ?? '';
  return escapeHTML(raw).replace(/\n/g,'<br>');
}
function normalizeAuthorId(c){ return c.authorId ?? c.userId ?? c.user_id ?? c.writerId ?? c.writer_id ?? null; }
function normalizeAuthorImg(c){ return c.authorImg ?? c.userImg ?? c.profile_img ?? c.img ?? ''; }
function normalizeAuthorName(c){ return c.authorName ?? c.username ?? c.userName ?? c.name ?? '익명'; }
function normalizeCreatedAt(c){
  const v = c.created_at ?? c.createdAt ?? c.created ?? c.updated_at ?? '';
  return String(v).replace('T',' ').slice(0,16);
}
function renderComments(list, meId){
  const ul = document.getElementById('commentList');
  ul.innerHTML = list.map(c => {
    const isMe = String(normalizeAuthorId(c)) === String(meId);
    const text = normalizeCommentText(c);
    return `
      <li ${isMe ? 'class="me"':''}>
        <div class="reply-head">
          <div class="inner">
            <img src="${normalizeAuthorImg(c) || './asset/images/img_arround_thumb_01.png'}" alt="">
            <div>
              <strong>${normalizeAuthorName(c)}</strong>
              ${isMe ? '<span>나의 댓글</span>' : ''}
              <time>${normalizeCreatedAt(c)}</time>
            </div>
          </div>
          ${isMe ? `
          <div class="dropdown-box">
            <button type="button" class="dropdown-btn" data-cid="${c.id}">더보기</button>
            <div class="dropdown-inner" role="menu" hidden>
              <ul>
                <li><a href="javascript:;" class="delete" data-cid="${c.id}">삭제하기</a></li>
              </ul>
            </div>
          </div>` : `
            <a href="javascript:;" class="sign" data-cid="${c.id}">신고</a>
          `}
        </div>
        <div class="reply-body">
          <p class="ctext">${text}</p>
        </div>
      </li>`;
  }).join('');
  document.getElementById('emptyComments').classList.toggle('is-hidden', list.length>0);
  bindDropdowns();
}

/* ===== 신고/삭제 공용 모달 ===== */
function showCmModal(msg, title='알림', buttons){
  const m = document.getElementById('modal-common');
  document.getElementById('cmModalTitle').textContent = title;
  document.getElementById('cmModalMsg').textContent = msg || '';
  const btnWrap = document.getElementById('cmModalButtons');

  if (buttons && buttons.length){
    btnWrap.innerHTML = '';
    buttons.forEach(b=>{
      const a = document.createElement('a');
      a.href = 'javascript:;';
      a.className = 'btn ' + (b.className || 'btn-active') + ' btn-lg flex-lg-1';
      a.textContent = b.text || '확인';
      a.addEventListener('click', ()=>{ if (b.onClick) b.onClick(); });
      btnWrap.appendChild(a);
    });
  } else {
    btnWrap.innerHTML = '<a href="javascript:;" class="btn btn-active btn-lg flex-lg-1" id="cmModalOk">확인</a>';
    btnWrap.querySelector('#cmModalOk').onclick = hideCmModal;
  }

  try{
    if (typeof window.modalOpen === 'function'){
      const opener = document.createElement('a');
      opener.href='javascript:;'; opener.setAttribute('aria-haspopup','dialog');
      opener.setAttribute('aria-controls','modal-common'); opener.style.display='none';
      document.body.appendChild(opener);
      window.modalOpen({preventDefault:()=>{}}, opener);
      setTimeout(()=> opener.remove(), 0);
      return;
    }
  }catch(_) {}
  m.setAttribute('aria-hidden','false'); m.removeAttribute('inert');
}
function hideCmModal(){
  const m = document.getElementById('modal-common');
  try{ if (typeof window.modalClose === 'function'){ window.modalClose(m); return; } }catch(_){}
  m.setAttribute('aria-hidden','true'); m.setAttribute('inert','');
}

/* ===== 드롭다운 바인딩 ===== */
function bindDropdowns(){
  document.querySelectorAll('.dropdown-btn').forEach(btn=>{
    btn.onclick = () => {
      const box = btn.parentElement.querySelector('.dropdown-inner');
      const open = box.hasAttribute('hidden') ? false : true;
      if (open) box.setAttribute('hidden',''); else box.removeAttribute('hidden');
    };
  });

  // 삭제
  document.querySelectorAll('a.delete[data-cid]').forEach(a=>{
    a.onclick = ()=>{
      const id = a.getAttribute('data-cid');
      showCmModal('댓글을 삭제하시겠습니까?', '삭제하기', [
        { text:'취소', className:'btn-gray-outline', onClick: hideCmModal },
        { text:'삭제', className:'btn-active', onClick: async ()=>{
            try{
              const r = await safeFetch(`/api/records/comments/${id}`, { method:'DELETE' });
              if (r.status===204){ hideCmModal(); await loadComments(PAGING.page); }
              else{ hideCmModal(); showCmModal('삭제에 실패했어요.'); }
            }catch(_){ hideCmModal(); showCmModal('네트워크 오류로 실패했습니다.'); }
          }}
      ]);
    };
  });

  // 신고
  document.querySelectorAll('a.sign[data-cid]').forEach(a=>{
    a.onclick = ()=>{
      const id = a.getAttribute('data-cid');
      showCmModal('이 댓글을 신고하시겠습니까?', '신고하기', [
        { text:'취소', className:'btn-gray-outline', onClick: hideCmModal },
        { text:'신고', className:'btn-active', onClick: async ()=>{
            try{
              const r = await safeFetch(`/api/records/comments/${id}/report`, { method:'POST' });
              if (r.ok){ hideCmModal(); showCmModal('신고가 접수되었습니다.', '완료'); }
              else{
                const j = await r.json().catch(()=>({}));
                hideCmModal(); showCmModal(j.message || '신고 처리에 실패했습니다.');
              }
            }catch(_){ hideCmModal(); showCmModal('네트워크 오류로 실패했습니다.'); }
          }}
      ]);
    };
  });
}

/* ===== 페이징 ===== */
function renderPaging(page, size, hasMore, count){
  const wrap = document.getElementById('paging');
  const ul   = document.getElementById('pagingUl');
  const show = (count > 0) && (hasMore || page > 1);
  wrap.style.display = show ? 'block' : 'none';
  if (!show) { ul.innerHTML = ''; return; }

  ul.innerHTML = `
    <li class="pg prev ${page<=1?'disabled':''}"><a href="javascript:;" id="pgPrev">이전</a></li>
    <li class="active"><a href="javascript:;">${page}</a></li>
    <li class="pg next ${!hasMore?'disabled':''}"><a href="javascript:;" id="pgNext">다음</a></li>`;
  document.getElementById('pgPrev').onclick = ()=>{ if(page>1) loadComments(page-1); };
  document.getElementById('pgNext').onclick = ()=>{ if(hasMore) loadComments(page+1); };
}

/* ===== API ===== */
async function getRecordFull(id){
  const tryList = [
    `/api/records/${encodeURIComponent(id)}/full`,
    `/api/record/${encodeURIComponent(id)}/full`,
  ];
  let lastRes;
  for (const url of tryList){
    try{
      const r = await safeFetch(url, {}, { redirectOnAuth:false });
      if (r.ok) return r.json();
      lastRes = r;
    }catch(e){ lastRes = e; }
  }
  if (lastRes && lastRes.status && [401,403,419].includes(lastRes.status)) {
    localStorage.removeItem('accessToken');
    location.href = '/login_01.html';
  }
  throw lastRes || new Error('record_full_failed');
}
async function getComments(id, page=1, size=20){
  const qs = `?page=${page}&size=${size}`;
  const tryList = [
    `/api/records/${encodeURIComponent(id)}/comments${qs}`,
    `/api/record/${encodeURIComponent(id)}/comments${qs}`,
  ];
  let lastRes;
  for (const url of tryList){
    try{
      const r = await safeFetch(url, {}, { redirectOnAuth:false });
      if (r.ok) return r.json();
      lastRes = r;
    }catch(e){ lastRes = e; }
  }
  if (lastRes && lastRes.status && [401,403,419].includes(lastRes.status)) {
    localStorage.removeItem('accessToken');
    location.href = '/login_01.html';
  }
  throw lastRes || new Error('comments_fetch_failed');
}
async function postComment(id, content){
  const init = { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ content }) };
  const tryList = [
    `/api/records/${encodeURIComponent(id)}/comments`,
    `/api/record/${encodeURIComponent(id)}/comments`,
  ];
  let lastRes;
  for (const url of tryList){
    try{
      const r = await safeFetch(url, init, { redirectOnAuth:false });
      if (r.ok) return r.json();
      lastRes = r;
    }catch(e){ lastRes = e; }
  }
  if (lastRes && [401,403,419].includes(lastRes.status)) {
    localStorage.removeItem('accessToken');
    location.href = '/login_01.html';
  }
  throw lastRes || new Error('comment_post_failed');
}
async function getMe(){ const r = await safeFetch('/api/auth/me'); if(!r.ok) throw r; return r.json(); }

/* ===== 모달 유틸 ===== */
function showModal(){
  const modal = document.getElementById('modal-view');
  try{
    if (typeof window.modalOpen === 'function'){
      const opener = document.createElement('a');
      opener.setAttribute('href','javascript:;');
      opener.setAttribute('aria-haspopup','dialog');
      opener.setAttribute('aria-controls','modal-view');
      opener.style.display='none';
      document.body.appendChild(opener);
      const ev = { preventDefault: ()=>{} };
      window.modalOpen(ev, opener);
      setTimeout(()=> opener.remove(), 0);
      return;
    }
  }catch(e){}
  if (modal){ modal.setAttribute('aria-hidden','false'); modal.removeAttribute('inert'); }
}
function hideModal(){
  const m=document.getElementById('modal-view');
  try{ if (typeof window.modalClose === 'function'){ window.modalClose(m); return; } }catch(_){}
  if (m){ m.setAttribute('aria-hidden','true'); m.setAttribute('inert',''); }
}
function fullDateKR(iso){
  const d=new Date(iso); if(isNaN(d)) return '';
  const w='일월화수목금토'[d.getDay()];
  return `${d.getFullYear()}년 ${d.getMonth()+1}월 ${d.getDate()}일(${w})`;
}
function renderModal(rec, images){
  const titleISO = rec.created_at || new Date().toISOString();
  document.getElementById('modalTitle').textContent = `${fullDateKR(titleISO)} 감정기록`;

  const box = document.querySelector('#modal-view .emotion-view-box');
  const icon = getEmojiSrc(rec.emotion_type, rec.expression_type);
  const imgLis = (images||[]).map(u=>`<li style="background-image:url('${u}');"></li>`).join('');
  const owner = !!(rec.isOwner || [rec.userId,rec.user_id,rec.ownerId,rec.owner_id].some(v=> String(v)===String(__ME?.userId)));
  const recordIdReal = rec.recordId || rec.id || recordId;

  box.innerHTML = `
    <div class="view-head">
      <div class="view-head-left">
        <div class="emotion-thumb-box md"><img src="${icon}" alt=""></div>
        <strong>${rec.title || (EMOJI_LABEL[rec.emotion_type] || '감정기록')}</strong>
      </div>
      <div class="view-head-right">
        ${owner ? `
          <button type="button" class="delete" data-record-id="${recordIdReal}">삭제</button>
          <button type="button" class="update" data-record-id="${recordIdReal}">수정</button>
        ` : ``}
      </div>
    </div>
    <div class="view-body">
      <p>${String(rec.content||'').replace(/\n/g,'<br>')}</p>
      ${images && images.length ? `<ul class="image">${imgLis}</ul>` : ``}
    </div>
    <div class="view-foot">
      <p>${rec.place || ''}</p>
      ${(rec.visibility==='private') ? '<span class="lock">비공개</span>' : '<span>공개</span>'}
    </div>
  `;

  const delBtn = box.querySelector('button.delete');
  const editBtn = box.querySelector('button.update');
  if (delBtn) delBtn.onclick = ()=> handleDelete(recordIdReal);
  if (editBtn) editBtn.onclick = ()=> handleEdit(recordIdReal);
}
async function handleDelete(rid){
  if(!confirm('이 감정 기록을 삭제할까요?')) return;
  const res = await safeFetch(`/api/record/${encodeURIComponent(rid)}`, { method:'DELETE' });
  if (res.status === 204 || res.ok){ hideModal(); location.replace('/emotion_calendar.html'); }
  else { const msg = await res.text().catch(()=> ''); alert('삭제에 실패했어요.\n'+msg); }
}
async function handleEdit(rid){
  try{
    let res = await safeFetch(`/api/record-drafts/from-record/${encodeURIComponent(rid)}`, { method:'POST' });
    if (res.ok){
      const j = await res.json().catch(()=> ({}));
      const draftId = j?.draftId || j?.id;
      if (draftId){ location.href = `/emotion_select_01.html?draftId=${encodeURIComponent(draftId)}`; return; }
    }
  }catch(_){}
  try{
    let res = await safeFetch(`/api/record-drafts/from-record`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ recordId: rid })
    });
    if (res.ok){
      const j = await res.json().catch(()=> ({}));
      const draftId = j?.draftId || j?.id;
      if (draftId){ location.href = `/emotion_select_01.html?draftId=${encodeURIComponent(draftId)}`; return; }
    }
  }catch(_){}
  location.href = `/emotion_select_01.html?recordId=${encodeURIComponent(rid)}`;
}

/* ===== 데이터 로딩 ===== */
const recordIdParam = (new URLSearchParams(location.search)).get('recordId');
const recordId = Number(recordIdParam);
if (!Number.isFinite(recordId)) {
  alert('잘못된 게시글 번호입니다.');
  history.back();
  throw new Error('invalid_record_id');
}
function extractCommentList(data){
  if (Array.isArray(data)) return data;
  if (Array.isArray(data?.comments)) return data.comments;
  if (Array.isArray(data?.items)) return data.items;
  if (Array.isArray(data?.data)) return data.data;
  return [];
}
async function loadRecord(){
  try{
    const { record, images } = await getRecordFull(recordId);
    __REC = record || {};
    __REC_VIS = (__REC.visibility || 'public');
    toggleCommentInput(__REC_VIS === 'public');
    setTitle(__REC.userImg, __REC.userName);
    renderRecordCard(__REC, images);

    document.getElementById('openModalBtn').onclick = ()=>{
      const imgs = Array.isArray(images) ? [...images] : [];
      if (__REC.representative_img && !imgs.includes(__REC.representative_img)) imgs.unshift(__REC.representative_img);
      renderModal(__REC, imgs);
      showModal();
    };
  }catch(err){
    let msg = '게시물을 불러오지 못했어요.';
    try{ const j = await err.json(); if (j?.message) msg = j.message; }catch(_){}
    alert(msg); history.back();
  }
}
async function loadComments(page=1){
  try{
    const data = await getComments(recordId, page, PAGING.size);
    PAGING.page = data.page || page;
    const list = extractCommentList(data);
    renderComments(list, __ME?.userId);
    renderPaging(PAGING.page, PAGING.size, list.length === PAGING.size, list.length);
  }catch(_){
    renderComments([], __ME?.userId);
    renderPaging(1, PAGING.size, false, 0);
  }
}

/* ===== 이벤트 ===== */
document.getElementById('commentSubmit').onclick = async ()=>{
  const ta = document.getElementById('commentInput');
  const btn = document.getElementById('commentSubmit');
  const content = ta.value.trim();
  if (!content) return ta.focus();
  btn.disabled = true;
  try{
    await postComment(recordId, content);
    ta.value = '';
    await loadComments(1);
  }catch(err){
    let msg = '댓글 등록에 실패했습니다.';
    try{ const j = await err.json(); if (j?.message) msg = j.message; }catch(_){}
    alert(msg);
  }finally{
    btn.disabled = false;
  }
};
/* 통일된 로그아웃 버튼 동작 */
document.getElementById('logoutBtn').onclick = (e)=>{ e.preventDefault(); localStorage.removeItem('accessToken'); location.href='/'; };

/* 레거시 인라인 핸들러 호환 */
window.modalOpen = window.modalOpen || function(ev, opener){
  const m=document.getElementById('modal-view');
  if (ev && ev.preventDefault) ev.preventDefault();
  m && (m.setAttribute('aria-hidden','false'), m.removeAttribute('inert'));
};
window.modalClose = window.modalClose || function(){
  const m=document.getElementById('modal-view');
  m && (m.setAttribute('aria-hidden','true'), m.setAttribute('inert',''));
};

/* ===== 초기화 ===== */
(async function init(){
  // 헤더 표시 상태
  (window.renderHeaderByAuth || renderHeaderByAuthLocal)();

  // 인증 상태 확인 (만료/무토큰은 로그인으로 유도)
  const token = getRawToken();
  if (!token || isExpired()){
    try { localStorage.removeItem('accessToken'); } catch(_){}
    redirectToLogin();
    return;
  }
  try { __ME = await getMe(); } catch(_) {}

  await loadRecord();
  await loadComments(1);
})();
</script>
</body>
</html>