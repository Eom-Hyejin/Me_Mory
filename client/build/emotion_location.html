<!DOCTYPE HTML>
<html lang="ko">
<head>
  <title>Memory</title>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#162060" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="text/html; charset=UTF-8; X-Content-Type-Options=nosniff" http-equiv="Content-Type">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
  <!-- CSS -->
  <link rel="stylesheet" href="./asset/css/swiper.min.css">
  <link rel="stylesheet" href="./asset/css/base.css">
  <link rel="stylesheet" href="./asset/css/grid.css?a=2">
  <link rel="stylesheet" href="./asset/css/common.css?a=2">
  <link rel="stylesheet" href="./asset/css/layout.css">
  <!-- JS -->
  <script src="./asset/js/jquery-3.3.1.js"></script>
  <script src="./asset/js/swiper.min.js"></script>
  <script src="./asset/js/common.js?a=1"></script>
  <!-- âœ… Kakao Maps SDK -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f4aa439c7ba1f3a816ecec2b2c36eab&libraries=services"></script>
  <style>
    .is-hidden{display:none!important}
    .btn[disabled]{opacity:.5; pointer-events:none}
    .emotion-chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#f4f6ff;font-weight:600;font-size:14px}
    .emotion-chip img{width:20px;height:20px;border-radius:50%}
    /* í˜ì´ì§€ ë‚´ ìœ„ê²½ë„ í…ìŠ¤íŠ¸ëŠ” ìˆ¨ê¹€ */
    #coordInfo{display:none}

    /* ===== ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ===== */
    .modal{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center}
    .modal.is-hidden{display:none!important}
    .modal-dim{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .modal-panel{
      position:relative; width:min(960px,92vw); max-height:90vh;
      background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.2);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .modal-header{padding:14px 16px;border-bottom:1px solid #eef0f5;display:flex;align-items:center;justify-content:space-between}
    .modal-title{font-weight:700}
    .modal-close{border:none;background:transparent;font-size:18px;cursor:pointer}
    .modal-body{padding:12px 16px;overflow:auto}
    .modal-footer{padding:12px 16px;border-top:1px solid #eef0f5;display:flex;gap:8px;justify-content:flex-end}
    .map-area{width:100%;height:420px;margin-top:12px;border:1px solid #e6e8ef;border-radius:12px;overflow:hidden}
    .muted{color:#7a7a7a;font-size:12px}
    .input-row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .input-row input[type="text"]{flex:1}
	.modal .modal-footer .btn,
	.modal #modalMyLocBtn{
  		background: transparent !important;
  		border: 0 !important;
  		box-shadow: none !important;
  		color: #3b5bff !important;      /* ê¸°ì¡´ ëŠë‚Œì˜ íŒŒë€ í…ìŠ¤íŠ¸ */
  		padding: 8px 10px;              /* í´ë¦­ ì˜ì—­ì€ ìœ ì§€ */
  		cursor: pointer;
	}

	/* hover/focus ì ‘ê·¼ì„± */
	.modal .modal-footer .btn:hover,
	.modal #modalMyLocBtn:hover{
  		text-decoration: underline;
	}
	.modal .modal-footer .btn:focus-visible,
	.modal #modalMyLocBtn:focus-visible{
  		outline: 2px solid rgba(59,91,255,.35);
  		outline-offset: 2px;
  		border-radius: 8px;
	}
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <header>
    <div class="container">
      <div class="header-logo">
        <h1><a href="/"><img src="./asset/images/logo.png" alt="Memory"/></a></h1>
      </div>
      <div class="header-cate">
        <ul>
          <li class="active"><a href="#" data-nav="record">ê°ì •ê¸°ë¡</a></li>
          <li><a href="#" data-nav="calendar">ê°ì •ìº˜ë¦°ë”</a></li>
          <li><a href="#" data-nav="around">ë‚´ ì£¼ë³€ ê°ì •</a></li>
          <li><a href="#" data-nav="map">ê°ì •ì§€ë„</a></li>
          <li><a href="#" data-nav="memory">ê°ì •íšŒê³ </a></li>
        </ul>
      </div>
      <div class="header-right">
        <!-- ê²ŒìŠ¤íŠ¸ -->
        <div class="right-button header-guest">
          <ul>
            <li class="border"><a href="#" data-nav="login">ë¡œê·¸ì¸</a></li>
            <li><a href="#" data-nav="register">íšŒì›ê°€ì…</a></li>
          </ul>
        </div>
        <!-- ë¡œê·¸ì¸ -->
        <div class="right-button header-user is-hidden">
          <ul>
            <li class="border"><a href="#" data-nav="mypage">ë§ˆì´í˜ì´ì§€</a></li>
            <li><a href="#" data-nav="logout">ë¡œê·¸ì•„ì›ƒ</a></li>
          </ul>
        </div>
        <div class="right-menu">
          <button type="button" class="menu" onclick="activeParent(this, 'right-menu');">ë©”ë‰´ë°”</button>
          <div class="inner">
            <ul>
              <li><a href="#" data-nav="record">ê°ì •ê¸°ë¡</a></li>
              <li><a href="#" data-nav="calendar">ê°ì •ìº˜ë¦°ë”</a></li>
              <li><a href="#" data-nav="around">ë‚´ ì£¼ë³€ ê°ì •</a></li>
              <li><a href="#" data-nav="map">ê°ì •ì§€ë„</a></li>
              <li><a href="#" data-nav="memory">ê°ì •íšŒê³ </a></li>
              <!-- ë¡œê·¸ì¸ ìƒíƒœ -->
              <li class="header-user-item is-hidden"><a href="#" data-nav="mypage">ë§ˆì´í˜ì´ì§€</a></li>
              <li class="header-user-item is-hidden ye"><a href="#" data-nav="logout">ë¡œê·¸ì•„ì›ƒ</a></li>
              <!-- ê²ŒìŠ¤íŠ¸ ìƒíƒœ -->
              <li class="header-guest-item"><a href="#" data-nav="login">ë¡œê·¸ì¸</a></li>
              <li class="header-guest-item"><a href="#" data-nav="register">íšŒì›ê°€ì…</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ë³¸ë¬¸ -->
  <section class="py-lg-0">
    <div class="full-box">
      <div class="full-inner full-height">
        <div class="circle-box cate-01">
          <div class="circle-inner">
            <div class="circle-head">
              <div class="step-box step-04"><div class="bar"></div></div>
            </div>
            <div class="circle-body">
              <div class="circle-title">
                <div class="inner">
                  <div class="is-m">
                    <div class="emotion-result-box">
                      <div class="result"><img id="emojiPreviewTop" src="./asset/images/icon_happy_02.png" alt=""></div>
                    </div>
                  </div>
                  <h2 class="md">ì˜¤ëŠ˜ì˜ ê°ì •ì€ <br class="is-m"/>ì–´ë””ë¡œ ê¸°ë¡í• ê¹Œìš”?</h2>
                  <div class="mt12">
                    <span id="emotionChip" class="emotion-chip is-hidden">
                      <img id="emotionChipImg" src="./asset/images/icon_happy_02.png" alt="">
                      <span id="emotionChipText"></span>
                    </span>
                  </div>
                </div>
              </div>

              <div class="write-box">
                <ul>
                  <!-- ì¥ì†Œ/ì§€ë„ -->
                  <li class="full">
                    <strong class="active">ê¸°ë¡í•  ì¥ì†Œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”</strong>
                    <div class="input-box active">
                      <input type="text" id="placeInput" placeholder="ì˜ˆ) ê°•ë‚¨ì—­ ì¹´í˜"/>
                      <!-- ğŸ” ë‹ë³´ê¸° ë²„íŠ¼ â†’ ì§€ë„ íŒì—… ì—´ê¸° -->
                      <button type="button" id="btnSearchPlace" class="search">ê²€ìƒ‰</button>
                    </div>
                    <div class="input-row">
                      <!-- ë‚´ ìœ„ì¹˜ ë²„íŠ¼ì€ íŒì—… ë‚´ë¶€ì—ì„œ ì œê³µ â†’ ì—¬ê¸°ì„  ì•ˆë‚´ë§Œ -->
                      <span id="coordInfo" class="muted"> </span>
                    </div>
                    <!-- âš ï¸ í˜ì´ì§€ ë³¸ë¬¸ì—ì„œëŠ” ì§€ë„ DOMì„ ë‘ì§€ ì•ŠìŠµë‹ˆë‹¤ (íŒì—… ì „ìš©) -->
                  </li>

                  <!-- ê³µê°œ ì—¬ë¶€ -->
                  <li class="full">
                    <strong class="active">ê³µê°œ ì—¬ë¶€ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”</strong>
                    <div class="radio-check-box">
                      <ul>
                        <li><input type="radio" name="visibility" id="vis_public" value="public"/><label for="vis_public" class="eye">ê³µê°œ</label></li>
                        <li><input type="radio" name="visibility" id="vis_private" value="private"/><label for="vis_private" class="eye-off">ë¹„ê³µê°œ</label></li>
                      </ul>
                    </div>
                  </li>

                  <!-- ë˜ëŒì•„ë³¼ ì‹œì  -->
                  <li class="full">
                    <strong class="active">ë˜ëŒì•„ë³¼ ì‹œì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</strong>
                    <div class="radio-check-box">
                      <ul>
                        <li><input type="radio" name="period" id="per_none" value="none"/><label for="per_none">ë‹¤ì‹œ ë³´ì§€ ì•ŠìŒ</label></li>
                        <li><input type="radio" name="period" id="per_6" value="6"/><label for="per_6">6ê°œì›” ë’¤</label></li>
                        <li><input type="radio" name="period" id="per_12" value="12"/><label for="per_12">1ë…„ ë’¤</label></li>
                      </ul>
                    </div>
                  </li>
                </ul>
              </div>
            </div>

            <div class="circle-foot">
              <div class="button-box">
                <a id="prevBtn" href="#" class="btn btn-active-outline w100 flex-0 mr12 mr-lg-8">ì´ì „ ë‹¨ê³„</a>
                <a id="nextBtn" href="#" class="btn btn-active flex-1">ë‹¤ìŒ</a>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- í•˜ë‹¨ í° í”„ë¦¬ë·° -->
  <div class="circle-border-box">
    <div class="inner">
      <div>
        <div class="emotion-result-box mb0">
          <div class="result"><img id="emojiPreviewBottom" src="./asset/images/icon_happy_02.png" alt=""></div>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-box">
    <img src="./asset/images/bg_body_cate_01.png" class="is-pc" alt="">
    <img src="./asset/images/bg_body_cate_01_m.png" class="is-m" alt="">
  </div>

  <!-- ===== ì§€ë„ ëª¨ë‹¬ ===== -->
  <div id="mapModal" class="modal is-hidden" role="dialog" aria-modal="true" aria-labelledby="mapModalTitle">
    <div class="modal-dim"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <div class="modal-title" id="mapModalTitle">ì¥ì†Œ ì„ íƒ</div>
        <button type="button" class="modal-close" id="mapCloseBtn" aria-label="ë‹«ê¸°">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="input-row">
          <input type="text" id="modalSearchInput" placeholder="ì¥ì†Œ ë˜ëŠ” ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
          <button type="button" id="modalSearchBtn" class="search">ê²€ìƒ‰</button>
          <button type="button" id="modalMyLocBtn" class="btn btn-active-outline">ë‚´ ìœ„ì¹˜</button>
        </div>
        <div id="map" class="map-area"></div>
        <p class="muted">ì§€ë„ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”. â€œì´ ìœ„ì¹˜ ì‚¬ìš©â€ì„ ëˆ„ë¥´ë©´ ì ìš©ë©ë‹ˆë‹¤.</p>
      </div>
      <div class="modal-footer">
        <button type="button" id="mapCancelBtn" class="btn btn-active-outline">ì·¨ì†Œ</button>
        <button type="button" id="mapUseBtn" class="btn btn-active">ì´ ìœ„ì¹˜ ì‚¬ìš©</button>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="./asset/js/swiper.js?a=1"></script>
  <script src="/asset/js/app.js?ver=6"></script>
  <script>
    /* ========= ê³µí†µ ìœ í‹¸ ========= */
    const getToken = () => localStorage.getItem('accessToken') || '';
    const isLoggedIn = () => !!getToken();
    function renderHeaderByAuth(){
      const on=isLoggedIn();
      document.querySelectorAll('.header-guest, .header-guest-item').forEach(el=>el.classList.toggle('is-hidden',on));
      document.querySelectorAll('.header-user, .header-user-item').forEach(el=>el.classList.toggle('is-hidden',!on));
    }
    const go=(url)=>window.location.href=url;

    document.addEventListener('click', async (e)=>{
      const a=e.target.closest('[data-nav]'); if(!a) return;
      e.preventDefault();
      const k=a.getAttribute('data-nav');
      if(k==='login') return go('/login_01.html');
      if(k==='register') return go('/register_01.html');
      if(k==='logout'){ localStorage.removeItem('accessToken'); renderHeaderByAuth(); return go('/'); }
      if(k==='mypage') return isLoggedIn()?go('/mypage_main.html'):go('/login_01.html');
      if(!isLoggedIn()) return go('/login_01.html');
      switch(k){
        case 'record':  return go('/emotion_select_01.html');
        case 'calendar':return go('/emotion_calendar.html');
        case 'map':     return go('/emotion_map.html');
        case 'memory':  return go('/emotion_memory.html');
        case 'around':  return go('/emotion_arround_bluetooth.html');
      }
    });

    /* ========= ìƒíƒœ ========= */
    const qs = new URLSearchParams(location.search);
    const draftId = qs.get('draftId');
    const EMO_KO = { joy:'ê¸°ì¨', sadness:'ìŠ¬í””', anger:'ë¶„ë…¸', worry:'ê±±ì •', proud:'ë¿Œë“¯', upset:'ì†ìƒ' };

    const emojiPreviewTop    = document.getElementById('emojiPreviewTop');
    const emojiPreviewBottom = document.getElementById('emojiPreviewBottom');
    const emotionChip        = document.getElementById('emotionChip');
    const emotionChipImg     = document.getElementById('emotionChipImg');
    const emotionChipText    = document.getElementById('emotionChipText');

    const placeInput       = document.getElementById('placeInput');
    const btnSearchPlace   = document.getElementById('btnSearchPlace');

    const visPublic        = document.getElementById('vis_public');
    const visPrivate       = document.getElementById('vis_private');
    const perNone          = document.getElementById('per_none');
    const per6             = document.getElementById('per_6');
    const per12            = document.getElementById('per_12');

    const prevBtn          = document.getElementById('prevBtn');
    const nextBtn          = document.getElementById('nextBtn');

    // ëª¨ë‹¬ ìš”ì†Œ
    const mapModal       = document.getElementById('mapModal');
    const mapCloseBtn    = document.getElementById('mapCloseBtn');
    const mapCancelBtn   = document.getElementById('mapCancelBtn');
    const mapUseBtn      = document.getElementById('mapUseBtn');
    const modalSearch    = document.getElementById('modalSearchInput');
    const modalSearchBtn = document.getElementById('modalSearchBtn');
    const modalMyLocBtn  = document.getElementById('modalMyLocBtn');

    /* ========= Draft IO ========= */
    function getLocalTempDraft(){ try{ return JSON.parse(localStorage.getItem('recordDraft.temp')||'null'); }catch(e){ return null; } }
    function saveLocalTemp(updates){ const cur=getLocalTempDraft()||{}; localStorage.setItem('recordDraft.temp', JSON.stringify({...cur,...updates,ts:Date.now()})); }
    async function fetchServerDraft(id){
      if(!isLoggedIn()||!id) return null;
      try{
        const r = await fetch(`/api/record-drafts/drafts/${encodeURIComponent(id)}`, { headers:{'Authorization':getToken()} });
        if(!r.ok) return null;
        return await r.json();
      }catch(e){ return null; }
    }
    async function patchServerDraft(id, payload){
      if(!isLoggedIn()||!id) return false;
      try{
        const r = await fetch(`/api/record-drafts/drafts/${encodeURIComponent(id)}`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json','Authorization':getToken()},
          body: JSON.stringify(payload)
        });
        return r.ok;
      }catch(e){ return false; }
    }
    const persist = async (payload)=>{ let ok=false; if(draftId) ok=await patchServerDraft(draftId,payload); if(!ok) saveLocalTemp(payload); };

    /* ========= Kakao ì§€ë„ (ëª¨ë‹¬ ë‚´ ì´ˆê¸°í™”) ========= */
    let map, marker, geocoder, places, mapInited=false;
    let selected = {lat:null, lng:null, addr:''};

    function ensureMap(){
      if(mapInited) return;
      const container = document.getElementById('map');
      const options = { center: new kakao.maps.LatLng(36.5, 127.9), level: 13 };
      map = new kakao.maps.Map(container, options);
      marker = new kakao.maps.Marker({ map });
      geocoder = new kakao.maps.services.Geocoder();
      places = new kakao.maps.services.Places();
      mapInited = true;

      // ì§€ë„ í´ë¦­ â†’ ë§ˆì»¤ ì´ë™ + ì—­ì§€ì˜¤ì½”ë”©
      kakao.maps.event.addListener(map, 'click', function(mouseEvent){
        const latlng = mouseEvent.latLng;
        setMarkerAndState(latlng.getLat(), latlng.getLng(), null, true);
      });
    }

    function relayoutMap(){
      // ëª¨ë‹¬ í‘œì‹œ í›„ ë¦¬ë ˆì´ì•„ì›ƒ
      if(!mapInited) return;
      setTimeout(()=>{ map.relayout(); }, 0);
    }

    function setMarkerAndState(lat, lng, addr=null, doReverse=false){
      const coord = new kakao.maps.LatLng(lat, lng);
      map.setLevel(3);
      map.setCenter(coord);
      marker.setPosition(coord);

      if (doReverse){
        geocoder.coord2Address(lng, lat, function(result, status){
          const got = (status===kakao.maps.services.Status.OK)
            ? (result[0].road_address?.address_name || result[0].address?.address_name || '')
            : '';
          selected = {lat, lng, addr: got};
          if (got) modalSearch.value = got;
        });
      } else {
        selected = {lat, lng, addr: addr||selected.addr||''};
        if (addr) modalSearch.value = addr;
      }
    }

    // í‚¤ì›Œë“œ ìš°ì„  â†’ ì‹¤íŒ¨ ì‹œ ì£¼ì†Œê²€ìƒ‰ (ëª¨ë‹¬ ì „ìš©)
    function modalSearchPlace(keyword){
      const q = (keyword||'').trim();
      if(!q) return;
      places.keywordSearch(q, function(results, status){
        if (status === kakao.maps.services.Status.OK && results.length){
          const r = results[0];
          setMarkerAndState(parseFloat(r.y), parseFloat(r.x), r.place_name, false);
        } else {
          geocoder.addressSearch(q, function(result, status2){
            if (status2 === kakao.maps.services.Status.OK && result.length){
              setMarkerAndState(parseFloat(result[0].y), parseFloat(result[0].x), q, false);
            } else {
              alert('í•´ë‹¹ ì¥ì†Œ/ì£¼ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”.');
            }
          });
        }
      });
    }

    // ë¸Œë¼ìš°ì € GPS â†’ ì—­ì§€ì˜¤ì½”ë”© (ëª¨ë‹¬ ì „ìš©)
    function modalUseMyLocation(){
      if (!('geolocation' in navigator)) return alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      navigator.geolocation.getCurrentPosition(
        pos=>{
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          setMarkerAndState(lat, lng, null, true);
        },
        err=> alert('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: '+err.message),
        { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
      );
    }

    /* ========= ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° ========= */
    function openMapModal(initialQuery){
      mapModal.classList.remove('is-hidden');
      ensureMap();
      relayoutMap();

      // ê¸°ì¡´ ì„ íƒê°’ì´ ìˆìœ¼ë©´ ê·¸ ìœ„ì¹˜ë¡œ, ì—†ìœ¼ë©´ í•œë°˜ë„ ì¤Œ
      const cur = getLocalTempDraft() || {};
      if (Number.isFinite(cur.latitude) && Number.isFinite(cur.longitude)){
        setMarkerAndState(Number(cur.latitude), Number(cur.longitude), cur.place||'', false);
      }

      // ì´ˆê¸° ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ìë™ ê²€ìƒ‰
      modalSearch.value = initialQuery || '';
      if (modalSearch.value.trim()){
        modalSearchPlace(modalSearch.value);
      }
    }
    function closeMapModal(){
      mapModal.classList.add('is-hidden');
    }

    /* ========= UI/ì´ˆê¸°í™” ========= */
    function applyPreview({img, emotion_type}){
      if(img){ emojiPreviewTop.src=img; emojiPreviewBottom.src=img; emotionChipImg.src=img; }
      const emoText = EMO_KO[emotion_type] || '';
      if (emoText){ emotionChip.classList.remove('is-hidden'); emotionChipText.textContent = emoText; }
      else { emotionChip.classList.add('is-hidden'); emotionChipText.textContent=''; }
    }
    function applyOptions({place, visibility, period}){
      if (typeof place==='string') placeInput.value = place;
      if (visibility === 'public') visPublic.checked = true; else visPrivate.checked = true;
      if (period==='6') per6.checked = true; else if (period==='12') per12.checked = true; else perNone.checked = true;
    }

    async function init(){
      renderHeaderByAuth();

      let data = null;
      if (draftId) data = await fetchServerDraft(draftId);
      if (!data)  data = getLocalTempDraft() || {};

      applyPreview({ img: data.img, emotion_type: data.emotion_type });
      applyOptions({
        place: data.place,
        visibility: data.visibility || 'private',
        period: data.period || 'none'
      });

      // ì´ë²¤íŠ¸ ë°”ì¸ë”© (ëª¨ë‹¬ ì˜¤í”ˆ)
      btnSearchPlace.addEventListener('click', ()=> openMapModal(placeInput.value));
      // ì…ë ¥ì°½ ì—”í„° â†’ íŒì—… ì—´ê³  ê²€ìƒ‰
      placeInput.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){
          e.preventDefault();
          openMapModal(placeInput.value);
        }
      });

      // ëª¨ë‹¬ ë‚´ë¶€
      modalSearchBtn.addEventListener('click', ()=> modalSearchPlace(modalSearch.value));
      modalSearch.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); modalSearchPlace(modalSearch.value); }});
      modalMyLocBtn.addEventListener('click', modalUseMyLocation);
      mapUseBtn.addEventListener('click', async ()=>{
        // ì„ íƒê°’ ì ìš© + ì €ì¥
        placeInput.value = selected.addr || modalSearch.value || '';
        const payload = {
          place: placeInput.value || null,
          latitude: selected.lat,
          longitude: selected.lng
        };
        await persist(payload);
        closeMapModal();
      });
      mapCancelBtn.addEventListener('click', closeMapModal);
      mapCloseBtn.addEventListener('click', closeMapModal);
      mapModal.querySelector('.modal-dim').addEventListener('click', closeMapModal);

      [visPublic, visPrivate].forEach(r=> r.addEventListener('change', ()=>{ if(r.checked) persist({ visibility:r.value }); }));
      [perNone, per6, per12].forEach(r=> r.addEventListener('change', ()=>{ if(r.checked) persist({ period:r.value }); }));

      prevBtn.addEventListener('click', (e)=>{ e.preventDefault(); go(`/emotion_text.html${draftId?`?draftId=${encodeURIComponent(draftId)}`:''}`); });
      nextBtn.addEventListener('click', async (e)=>{
        e.preventDefault();
        // ë§ˆì§€ë§‰ ë™ê¸°í™”(ì¥ì†Œ/ê³µê°œ/ì‹œì )
        const payload = {
          place: placeInput.value || null,
          visibility: visPublic.checked ? 'public' : 'private',
          period: per6.checked ? '6' : (per12.checked ? '12' : 'none')
        };
        let ok=false; if(draftId) ok=await patchServerDraft(draftId,payload); if(!ok) saveLocalTemp(payload);
        go(`/emotion_result.html${draftId?`?draftId=${encodeURIComponent(draftId)}`:''}`);
      });

      window.addEventListener('storage',(ev)=>{ if(ev.key==='accessToken'){ renderHeaderByAuth(); }});
    }

    init();
  </script>
</body>
</html>