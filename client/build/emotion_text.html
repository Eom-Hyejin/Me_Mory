<!DOCTYPE HTML>
<html lang="ko">
<head>
  <title>Memory</title>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#162060" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="text/html; charset=UTF-8; X-Content-Type-Options=nosniff" http-equiv="Content-Type">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
  <link rel="stylesheet" href="./asset/css/swiper.min.css">
  <link rel="stylesheet" href="./asset/css/base.css">
  <link rel="stylesheet" href="./asset/css/grid.css?a=2">
  <link rel="stylesheet" href="./asset/css/common.css?a=2">
  <link rel="stylesheet" href="./asset/css/layout.css">
  <script src="./asset/js/jquery-3.3.1.js"></script>
  <script src="./asset/js/swiper.min.js"></script>
  <script src="./asset/js/common.js?a=1"></script>
  <style>
    .is-hidden{display:none!important}
    .btn[disabled]{opacity:.5; pointer-events:none}
    .emotion-chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#f4f6ff;font-weight:600;font-size:14px}
    .emotion-chip img{width:20px;height:20px;display:inline-block;vertical-align:middle;border-radius:50%}
    textarea{white-space:pre-wrap}
    #chipWrap, #emotionChip{display:none!important}

    .file-image-box li { position: relative; }
    .thumb { display:block; width:64px; height:64px; object-fit:cover; border-radius:10px; border:1px solid #e6e8ef; margin-top:8px }
    .thumb.empty { display:none; }

    /* ë‚¨ì•„ìˆëŠ” íŒíŠ¸/ìƒíƒœ ë¬¸êµ¬ ê°•ì œ ìˆ¨ê¹€ */
    .file-hint, [data-upload-status], .upload-status, .status-chip { display:none !important; }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <header>
    <div class="container">
      <div class="header-logo">
        <h1><a href="/"><img src="./asset/images/logo.png" alt="Memory"/></a></h1>
      </div>
      <div class="header-cate">
        <ul>
          <li class="active"><a href="#" data-nav="record">ê°ì •ê¸°ë¡</a></li>
          <li><a href="#" data-nav="calendar">ê°ì •ìº˜ë¦°ë”</a></li>
          <li><a href="#" data-nav="around">ë‚´ ì£¼ë³€ ê°ì •</a></li>
          <li><a href="#" data-nav="map">ê°ì •ì§€ë„</a></li>
          <li><a href="#" data-nav="memory">ê°ì •íšŒê³ </a></li>
        </ul>
      </div>
      <div class="header-right">
        <div class="right-button header-guest">
          <ul>
            <li class="border"><a href="#" data-nav="login">ë¡œê·¸ì¸</a></li>
            <li><a href="#" data-nav="register">íšŒì›ê°€ì…</a></li>
          </ul>
        </div>
        <div class="right-button header-user is-hidden">
          <ul>
            <li class="border"><a href="#" data-nav="mypage">ë§ˆì´í˜ì´ì§€</a></li>
            <li><a href="#" data-nav="logout">ë¡œê·¸ì•„ì›ƒ</a></li>
          </ul>
        </div>
        <div class="right-menu">
          <button type="button" class="menu" onclick="activeParent(this, 'right-menu');">ë©”ë‰´ë°”</button>
          <div class="inner">
            <ul>
              <li><a href="#" data-nav="record">ê°ì •ê¸°ë¡</a></li>
              <li><a href="#" data-nav="calendar">ê°ì •ìº˜ë¦°ë”</a></li>
              <li><a href="#" data-nav="around">ë‚´ ì£¼ë³€ ê°ì •</a></li>
              <li><a href="#" data-nav="map">ê°ì •ì§€ë„</a></li>
              <li><a href="#" data-nav="memory">ê°ì •íšŒê³ </a></li>
              <li class="header-user-item is-hidden"><a href="#" data-nav="mypage">ë§ˆì´í˜ì´ì§€</a></li>
              <li class="header-user-item is-hidden ye"><a href="#" data-nav="logout">ë¡œê·¸ì•„ì›ƒ</a></li>
              <li class="header-guest-item"><a href="#" data-nav="login">ë¡œê·¸ì¸</a></li>
              <li class="header-guest-item"><a href="#" data-nav="register">íšŒì›ê°€ì…</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ë³¸ë¬¸ -->
  <section class="py-lg-0">
    <div class="full-box">
      <div class="full-inner full-height">
        <div class="circle-box cate-01">
          <div class="circle-inner">
            <div class="circle-head">
              <div class="step-box step-03"><div class="bar"></div></div>
            </div>
            <div class="circle-body">
              <div class="circle-title">
                <div class="inner">
                  <div class="is-m">
                    <div class="emotion-result-box">
                      <div class="result">
                        <!-- âœ… ì—…ë¡œë“œ ì´ë¯¸ì§€ë¡œ êµì²´í•˜ì§€ ì•ŠìŒ -->
                        <img id="emojiPreviewTop" src="./asset/images/icon_happy_02.png" alt="preview">
                      </div>
                    </div>
                  </div>
                  <h2 class="md">
                    ê¸°ì–µí•˜ê³  ì‹¶ì€ ì˜¤ëŠ˜ì˜ ê°ì •ì„ ìì„¸í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš” <br/>
                    <span>ì‚¬ì§„ë„ í•¨ê»˜ ë‚¨ê¸¸ ìˆ˜ ìˆì–´ìš”</span>
                  </h2>
                  <div id="chipWrap" class="mt12">
                    <span id="emotionChip" class="emotion-chip is-hidden">
                      <img id="emotionChipImg" src="./asset/images/icon_happy_02.png" alt="">
                      <span id="emotionChipText"></span>
                    </span>
                  </div>
                </div>
              </div>

              <div class="textarea-box">
                <textarea id="content" placeholder="í•˜ê³  ì‹¶ì€ ë§ì„ ììœ ë¡­ê²Œ ë‚¨ê²¨ì£¼ì„¸ìš”."></textarea>
              </div>

              <div class="file-image-box">
                <ul>
                  <li>
                    <input type="file" id="file1" accept="image/*"/>
                    <label for="file1">íŒŒì¼ì²¨ë¶€ 1</label>
                    <img class="thumb empty" id="thumb1" alt="" style="display:none;">
                  </li>
                  <li>
                    <input type="file" id="file2" accept="image/*"/>
                    <label for="file2">íŒŒì¼ì²¨ë¶€ 2</label>
                    <img class="thumb empty" id="thumb2" alt="" style="display:none;">
                  </li>
                  <li>
                    <input type="file" id="file3" accept="image/*"/>
                    <label for="file3">íŒŒì¼ì²¨ë¶€ 3</label>
                    <img class="thumb empty" id="thumb3" alt="" style="display:none;">
                  </li>
                  <li>
                    <input type="file" id="file4" accept="image/*"/>
                    <label for="file4">íŒŒì¼ì²¨ë¶€ 4</label>
                    <img class="thumb empty" id="thumb4" alt="" style="display:none;">
                  </li>
                </ul>
              </div>
            </div>

            <div class="circle-foot">
              <div class="button-box">
                <a id="prevBtn" href="#" class="btn btn-active-outline w100 flex-0 mr12 mr-lg-8">ì´ì „ ë‹¨ê³„</a>
                <a id="nextBtn" href="#" class="btn btn-active flex-1">ë‹¤ìŒ</a>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- í•˜ë‹¨ í° í”„ë¦¬ë·°(ì—¬ê¸°ë„ ì—…ë¡œë“œ ì´ë¯¸ì§€ë¡œ êµì²´í•˜ì§€ ì•ŠìŒ) -->
  <div class="circle-border-box">
    <div class="inner">
      <div>
        <div class="emotion-result-box mb0">
          <div class="result"><img id="emojiPreviewBottom" src="./asset/images/icon_happy_02.png" alt=""></div>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-box">
    <img src="./asset/images/bg_body_cate_01.png" class="is-pc" alt="">
    <img src="./asset/images/bg_body_cate_01_m.png" class="is-m" alt="">
  </div>

  <script src="./asset/js/swiper.js?a=1"></script>
  <script src="/asset/js/app.js?ver=19"></script>
  <script>
    /* ========= ê³µí†µ ìœ í‹¸ ========= */
    const getToken = () => localStorage.getItem('accessToken') || '';
    const isLoggedIn = () => !!getToken();
    const authHeader = () => {
      const t = getToken();
      if (!t) return '';
      return t.startsWith('Bearer ') ? t : `Bearer ${t}`;
    };
    function renderHeaderByAuth(){
      const on=isLoggedIn();
      document.querySelectorAll('.header-guest, .header-guest-item').forEach(el=>el.classList.toggle('is-hidden',on));
      document.querySelectorAll('.header-user, .header-user-item').forEach(el=>el.classList.toggle('is-hidden',!on));
    }
    const go=(url)=>window.location.href=url;

    document.addEventListener('click', async (e)=>{
      const a=e.target.closest('[data-nav]'); if(!a) return;
      e.preventDefault();
      const k=a.getAttribute('data-nav');
      if(k==='login') return go('/login_01.html');
      if(k==='register') return go('/register_01.html');
      if(k==='logout'){ localStorage.removeItem('accessToken'); renderHeaderByAuth(); return go('/'); }
      if(k==='mypage') return isLoggedIn()?go('/mypage_main.html'):go('/login_01.html');
      if(!isLoggedIn()) return go('/login_01.html');
      switch(k){
        case 'record':  return go('/emotion_select_01.html');
        case 'calendar':return go('/emotion_calendar.html');
        case 'map':     return go('/emotion_map.html');
        case 'memory':  return go('/emotion_memory.html');
        case 'around':  return go('/emotion_arround_bluetooth.html');
      }
    });

    /* ========= í‚¤/ë§¤í•‘ ========= */
    const PREFIX_BY_EMO = {
      joy:'happy',
      sadness:'sad',
      anger:'angry',
      worry:'uneasy',
      proud:'proud',     // ğŸ”§ enviousê°€ ì•„ë‹ˆë¼ proudë¡œ ê³ ì •
      upset:'upset'
    };
    const INDEX_BY_CODE = {   // ê¸°ë³¸ ì•„ì´ì½˜ íŒŒì¼ëª…ì´ 02~07ì¸ ê²½ìš° ëŒ€ì‘
      emoji01:'02', emoji02:'03', emoji03:'04',
      emoji04:'05', emoji05:'06', emoji06:'07'
    };
    const DEFAULT_ICON = './asset/images/icon_happy_02.png';

    function resolveImg(emotion_type, expression_type){
      const prefix = PREFIX_BY_EMO[emotion_type];
      const idx = INDEX_BY_CODE[expression_type] || '02';
      if (!prefix) return DEFAULT_ICON;
      return `./asset/images/icon_${prefix}_${idx}.png`;
    }

    /* ========= ë“œë˜í”„íŠ¸ ì €ì¥/ì½ê¸° ========= */
    const qs = new URLSearchParams(location.search);
    const draftId = qs.get('draftId');

    const LS_KEY = 'recordDraft.temp';
    const getLocalTempDraft = () => {
      try { return JSON.parse(localStorage.getItem(LS_KEY)||'null'); }
      catch(e){ return null; }
    };
    const saveLocalTemp = (updates) => {
      const cur = getLocalTempDraft() || {};
      localStorage.setItem(LS_KEY, JSON.stringify({...cur, ...updates, ts: Date.now()}));
    };

    async function fetchServerDraft(id){
      if(!isLoggedIn()||!id) return null;
      try{
        const r = await fetch(`/api/record-drafts/drafts/${encodeURIComponent(id)}`, {
          headers:{'Authorization': authHeader()}
        });
        if(!r.ok) return null;
        return await r.json();
      }catch(e){ return null; }
    }
    async function patchServerDraft(id, payload){
      if(!isLoggedIn()||!id) return false;
      try{
        const r = await fetch(`/api/record-drafts/drafts/${encodeURIComponent(id)}`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json','Authorization': authHeader()},
          body: JSON.stringify(payload)
        });
        return r.ok;
      }catch(e){ return false; }
    }

    /* ========= Presigned URL ========= */
    async function getPresignedUrl(filename){
      const safe = filename || `image_${Date.now()}.png`;
      const res = await fetch(`/api/record-drafts/upload-url?filename=${encodeURIComponent(safe)}`, {
        headers: { 'Authorization': authHeader() }
      });
      if(!res.ok) throw new Error('upload-url ìƒì„± ì‹¤íŒ¨');
      return res.json(); // { uploadUrl, imageUrl }
    }

    /* ========= S3 ì—…ë¡œë“œ (ìŠ¤ë§ˆíŠ¸ ì¬ì‹œë„) ========= */
    async function putRaw(uploadUrl, file, headers) {
      const r = await fetch(uploadUrl, { method: 'PUT', headers, body: file });
      if (!r.ok) {
        const txt = await r.text().catch(()=> '');
        console.error('S3 PUT failed', r.status, r.statusText, txt);
        throw new Error(`S3 ì—…ë¡œë“œ ì‹¤íŒ¨: ${r.status}`);
      }
    }
    async function putToS3Smart(uploadUrl, file) {
      try { await putRaw(uploadUrl, file, undefined); return; } catch(e) {}
      const ct = file.type || 'application/octet-stream';
      try { await putRaw(uploadUrl, file, { 'Content-Type': ct }); return; } catch(e) {}
      try { await putRaw(uploadUrl, file, { 'Content-Type': ct, 'x-amz-acl': 'public-read' }); return; } catch(e) {}
      throw new Error('S3 ì—…ë¡œë“œ 3íšŒ ì‹¤íŒ¨');
    }

    /* ========= ì—˜ë¦¬ë¨¼íŠ¸ ========= */
    const emojiPreviewTop    = document.getElementById('emojiPreviewTop');
    const emojiPreviewBottom = document.getElementById('emojiPreviewBottom');
    const contentEl          = document.getElementById('content');
    const prevBtn            = document.getElementById('prevBtn');
    const nextBtn            = document.getElementById('nextBtn');

    const fileInputs = [1,2,3,4].map(i => document.getElementById('file'+i));
    const thumbs     = [1,2,3,4].map(i => document.getElementById('thumb'+i));

    /* ========= ìƒíƒœ/ì¸ë„¤ì¼ ========= */
    let uploadedImages = [null,null,null,null];

    function refreshThumb(slot, url){
      const img = thumbs[slot];
      if(url){ img.src=url; img.classList.remove('empty'); }
      else { img.src=''; img.classList.add('empty'); }
    }

    // ì”ì—¬ ìƒíƒœ ë¬¸êµ¬ ì œê±°
    function removeUploadStatusChips() {
      document.querySelectorAll('.file-image-box .file-hint, #hint1, #hint2, #hint3, #hint4').forEach(el=>el.remove());
      document.querySelectorAll('.status-chip, .upload-status, [data-upload-status]').forEach(el=>el.remove());
      // í…ìŠ¤íŠ¸ ë…¸ë“œë¡œë§Œ ë‚¨ì•„ìˆëŠ” "ì—…ë¡œë“œ ì™„ë£Œ" ì œê±°
      document.querySelectorAll('.file-image-box, .circle-border-box, body').forEach(scope=>{
        scope.querySelectorAll('*').forEach(el=>{
          if (el.childNodes.length===1 && el.childNodes[0].nodeType===3 && el.textContent.trim()==='ì—…ë¡œë“œ ì™„ë£Œ') {
            el.remove();
          }
        });
      });
    }

    async function uploadOneFile(slot, file){
      if(!file) return;
      const MAX_MB=15;
      if(file.size>MAX_MB*1024*1024){ return; }
      try{
        const { uploadUrl, imageUrl } = await getPresignedUrl(file.name);
        await putToS3Smart(uploadUrl,file);
        uploadedImages[slot]=imageUrl;
        refreshThumb(slot,imageUrl);

        // ëŒ€í‘œ ì´ë¯¸ì§€ëŠ” í”„ë¦¬ë·°(ì´ëª¨ì§€)ë¡œëŠ” ì“°ì§€ ì•ŠìŒ
        const representative = uploadedImages.find(Boolean) || null;
        const payload={ images: uploadedImages.filter(Boolean), img: representative };
        let ok=false; if(draftId) ok=await patchServerDraft(draftId,payload);
        if(!ok) saveLocalTemp(payload);

        removeUploadStatusChips();
      }catch(err){ console.error(err); }
    }

    function bindFileInputs(){
      fileInputs.forEach((input,i)=>{
        input.addEventListener('change',async()=>{
          const file=input.files&&input.files[0];
          if(!file){
            uploadedImages[i]=null;
            refreshThumb(i,null);
            const representative=uploadedImages.find(Boolean)||(getLocalTempDraft()?.img||null);
            if(draftId) await patchServerDraft(draftId,{images:uploadedImages.filter(Boolean),img:representative});
            saveLocalTemp({images:uploadedImages.filter(Boolean),img:representative});
            removeUploadStatusChips();
            return;
          }
          await uploadOneFile(i,file);
        });
      });
    }

    // ì•ˆì „í•œ ì´ë¯¸ì§€ ì ìš© (ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì•„ì´ì½˜)
    function setPreviewImg(imgEl, src){
      imgEl.onload = null;
      imgEl.onerror = () => { imgEl.src = DEFAULT_ICON; };
      imgEl.src = src || DEFAULT_ICON;
    }

    // ì´ëª¨ì§€/ê°ì • ë³µêµ¬
    function pickEmotionFromAllSources(serverData, localData){
  // 1) ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ìš°ì„ 
  const qEmo = qs.get('emotion_type');
  const qExpr = qs.get('expression_type');
  if(qEmo && qExpr) return { emotion_type:qEmo, expression_type:qExpr };

  // 2) ì„œë²„ ë“œë˜í”„íŠ¸ ë°ì´í„° ìš°ì„  (ì„œë²„ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê·¸ ë°ì´í„°ë¥¼ ì‚¬ìš©)
  if(serverData?.emotion_type && serverData?.expression_type)
    return { emotion_type:serverData.emotion_type, expression_type:serverData.expression_type };

  // 3) ë¡œì»¬ ë°ì´í„° (ê°€ì¥ ìµœê·¼ì— ì €ì¥ëœ ê°ì •/ì´ëª¨ì§€)
  if(localData?.emotion_type && localData?.expression_type)
    return { emotion_type:localData.emotion_type, expression_type:localData.expression_type };

  // 4) í´ë°± (ê¸°ë³¸ ê°ì • ì„¤ì •)
  return { emotion_type:'joy', expression_type:'emoji01' };
}

    // í”„ë¦¬ë·° ì ìš©(ì—…ë¡œë“œ ì´ë¯¸ì§€ë¡œ ë®ì–´ì“°ê¸° ê¸ˆì§€)
    function applyPreview({emotion_type, expression_type, content}){
      const derived = resolveImg(emotion_type,expression_type);
      setPreviewImg(emojiPreviewTop, derived);
      setPreviewImg(emojiPreviewBottom, derived);

      if(typeof content==='string') contentEl.value=content||'';
      saveLocalTemp({emotion_type,expression_type,img:derived});
      removeUploadStatusChips();
    }

    // ìƒˆ í”Œë¡œìš°ë©´ ê³¼ê±° ì´ë¯¸ì§€/ìƒíƒœ ì‹¹ ì •ë¦¬
    function clearOldImagesIfNewFlow(){
      if(draftId) return; // ì„œë²„ ë“œë˜í”„íŠ¸ê°€ ìˆìœ¼ë©´ ìœ ì§€
      uploadedImages=[null,null,null,null];
      thumbs.forEach((_,i)=>refreshThumb(i,null));
      const cur = getLocalTempDraft() || {};
      delete cur.images; delete cur.img;
      localStorage.setItem(LS_KEY, JSON.stringify({...cur, ts:Date.now()}));
      removeUploadStatusChips();
    }

    async function init(){
      renderHeaderByAuth();

      let server = null;
      if(draftId) server = await fetchServerDraft(draftId);
      const local  = getLocalTempDraft() || {};

      // ê°ì •/ì´ëª¨ì§€ ë³µêµ¬
      const picked = pickEmotionFromAllSources(server, local);
      applyPreview({ ...picked, content: (server?.content ?? local?.content ?? '') });

      // ì´ë¯¸ì§€ ë³µêµ¬: ì„œë²„ ë“œë˜í”„íŠ¸ê°€ ìˆì„ ë•Œë§Œ
      if (draftId && Array.isArray(server?.images) && server.images.length){
        uploadedImages=[null,null,null,null];
        server.images.slice(0,4).forEach((url,idx)=>{ uploadedImages[idx]=url; refreshThumb(idx,url); });
      } else {
        clearOldImagesIfNewFlow();
      }

      bindFileInputs();
      removeUploadStatusChips();

      prevBtn.addEventListener('click',(e)=>{
        e.preventDefault();
        const from=localStorage.getItem('recordDraft.fromPage')||'/emotion_select_02.html';
        let back=from;
        if(draftId){ const u=new URL(back,location.origin); u.searchParams.set('draftId',draftId); back=u.pathname+u.search; }
        go(back);
      });

      nextBtn.addEventListener('click',async(e)=>{
        e.preventDefault();
        const cur=getLocalTempDraft()||{};
        const representative=uploadedImages.find(Boolean)||cur.img||null;
        const payload={
          content: contentEl.value || '',
          emotion_type: cur.emotion_type || picked.emotion_type,
          expression_type: cur.expression_type || picked.expression_type,
          img: representative,
          images: uploadedImages.filter(Boolean)
        };
        let ok=false;
        if(draftId) ok = await patchServerDraft(draftId,payload);
        if(!ok) saveLocalTemp(payload);

        let url='/emotion_location.html';
        if(draftId) url+=`?draftId=${encodeURIComponent(draftId)}`;
        go(url);
      });
    }

    init();

    // í˜¹ì‹œ í˜ì´ì§€ êµì²´ ì‹œ ë‚¨ì•„ìˆëŠ” ìƒíƒœë¬¸êµ¬ê°€ ë³´ì´ëŠ” ê²½ìš° ë°©ì§€
    window.addEventListener('pageshow', removeUploadStatusChips);
  </script>
</body>
</html>