<!DOCTYPE HTML>
<html lang="ko">
<head>
  <title>Memory</title>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#162060" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="text/html; charset=UTF-8; X-Content-Type-Options=nosniff" http-equiv="Content-Type">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
  <link rel="stylesheet" href="./asset/css/swiper.min.css">
  <link rel="stylesheet" href="./asset/css/base.css">
  <link rel="stylesheet" href="./asset/css/grid.css?a=2">
  <link rel="stylesheet" href="./asset/css/common.css?a=2">
  <link rel="stylesheet" href="./asset/css/layout.css">
  <script src="./asset/js/jquery-3.3.1.js"></script>
  <script src="./asset/js/swiper.min.js"></script>
  <script src="./asset/js/common.js?a=1"></script>
  <style>
    .is-hidden{display:none!important}
    .btn[disabled]{opacity:.5; pointer-events:none}
    .emotion-chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#f4f6ff;font-weight:600;font-size:14px}
    .emotion-chip img{width:20px;height:20px;display:inline-block;vertical-align:middle;border-radius:50%}
    textarea{white-space:pre-wrap}
    /* 칩은 숨김 유지 */
    #chipWrap, #emotionChip{display:none!important}
    /* 간단 썸네일 프리뷰 */
    .file-image-box li { position: relative; }
    .thumb { display:block; width:64px; height:64px; object-fit:cover; border-radius:10px; border:1px solid #e6e8ef; margin-top:8px }
    .thumb.empty { display:none; }
    .file-hint { font-size:12px; color:#7a7a7a; margin-top:4px }
  </style>
</head>
<body>
  <!-- 헤더 -->
  <header>
    <div class="container">
      <div class="header-logo">
        <h1><a href="/"><img src="./asset/images/logo.png" alt="Memory"/></a></h1>
      </div>
      <div class="header-cate">
        <ul>
          <li class="active"><a href="#" data-nav="record">감정기록</a></li>
          <li><a href="#" data-nav="calendar">감정캘린더</a></li>
          <li><a href="#" data-nav="around">내 주변 감정</a></li>
          <li><a href="#" data-nav="map">감정지도</a></li>
          <li><a href="#" data-nav="memory">감정회고</a></li>
        </ul>
      </div>
      <div class="header-right">
        <div class="right-button header-guest">
          <ul>
            <li class="border"><a href="#" data-nav="login">로그인</a></li>
            <li><a href="#" data-nav="register">회원가입</a></li>
          </ul>
        </div>
        <div class="right-button header-user is-hidden">
          <ul>
            <li class="border"><a href="#" data-nav="mypage">마이페이지</a></li>
            <li><a href="#" data-nav="logout">로그아웃</a></li>
          </ul>
        </div>
        <div class="right-menu">
          <button type="button" class="menu" onclick="activeParent(this, 'right-menu');">메뉴바</button>
          <div class="inner">
            <ul>
              <li><a href="#" data-nav="record">감정기록</a></li>
              <li><a href="#" data-nav="calendar">감정캘린더</a></li>
              <li><a href="#" data-nav="around">내 주변 감정</a></li>
              <li><a href="#" data-nav="map">감정지도</a></li>
              <li><a href="#" data-nav="memory">감정회고</a></li>
              <li class="header-user-item is-hidden"><a href="#" data-nav="mypage">마이페이지</a></li>
              <li class="header-user-item is-hidden ye"><a href="#" data-nav="logout">로그아웃</a></li>
              <li class="header-guest-item"><a href="#" data-nav="login">로그인</a></li>
              <li class="header-guest-item"><a href="#" data-nav="register">회원가입</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- 본문 -->
  <section class="py-lg-0">
    <div class="full-box">
      <div class="full-inner full-height">
        <div class="circle-box cate-01">
          <div class="circle-inner">
            <div class="circle-head">
              <div class="step-box step-03"><div class="bar"></div></div>
            </div>
            <div class="circle-body">
              <div class="circle-title">
                <div class="inner">
                  <div class="is-m">
                    <div class="emotion-result-box">
                      <div class="result">
                        <img id="emojiPreviewTop" src="./asset/images/icon_happy_02.png" alt="preview">
                      </div>
                    </div>
                  </div>
                  <h2 class="md">
                    기억하고 싶은 오늘의 감정을 자세하게 작성해주세요 <br/>
                    <span>사진도 함께 남길 수 있어요</span>
                  </h2>
                  <div id="chipWrap" class="mt12">
                    <span id="emotionChip" class="emotion-chip is-hidden">
                      <img id="emotionChipImg" src="./asset/images/icon_happy_02.png" alt="">
                      <span id="emotionChipText"></span>
                    </span>
                  </div>
                </div>
              </div>

              <div class="textarea-box">
                <textarea id="content" placeholder="하고 싶은 말을 자유롭게 남겨주세요."></textarea>
              </div>

              <div class="file-image-box">
                <ul>
                  <li>
                    <input type="file" id="file1" accept="image/*"/>
                    <label for="file1">파일첨부 1</label>
                    <img class="thumb empty" id="thumb1" alt="">
                    <div class="file-hint" id="hint1"></div>
                  </li>
                  <li>
                    <input type="file" id="file2" accept="image/*"/>
                    <label for="file2">파일첨부 2</label>
                    <img class="thumb empty" id="thumb2" alt="">
                    <div class="file-hint" id="hint2"></div>
                  </li>
                  <li>
                    <input type="file" id="file3" accept="image/*"/>
                    <label for="file3">파일첨부 3</label>
                    <img class="thumb empty" id="thumb3" alt="">
                    <div class="file-hint" id="hint3"></div>
                  </li>
                  <li>
                    <input type="file" id="file4" accept="image/*"/>
                    <label for="file4">파일첨부 4</label>
                    <img class="thumb empty" id="thumb4" alt="">
                    <div class="file-hint" id="hint4"></div>
                  </li>
                </ul>
              </div>
            </div>

            <div class="circle-foot">
              <div class="button-box">
                <a id="prevBtn" href="#" class="btn btn-active-outline w100 flex-0 mr12 mr-lg-8">이전 단계</a>
                <a id="nextBtn" href="#" class="btn btn-active flex-1">다음</a>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 하단 큰 프리뷰 -->
  <div class="circle-border-box">
    <div class="inner">
      <div>
        <div class="emotion-result-box mb0">
          <div class="result"><img id="emojiPreviewBottom" src="./asset/images/icon_happy_02.png" alt=""></div>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-box">
    <img src="./asset/images/bg_body_cate_01.png" class="is-pc" alt="">
    <img src="./asset/images/bg_body_cate_01_m.png" class="is-m" alt="">
  </div>

  <script src="./asset/js/swiper.js?a=1"></script>
  <script src="/asset/js/app.js?ver=19"></script>
  <script>
    /* ========= 공통 유틸 ========= */
    const getToken = () => localStorage.getItem('accessToken') || '';
    const isLoggedIn = () => !!getToken();
    const authHeader = () => {
      const t = getToken();
      if (!t) return '';
      return t.startsWith('Bearer ') ? t : `Bearer ${t}`;
    };
    function renderHeaderByAuth(){
      const on=isLoggedIn();
      document.querySelectorAll('.header-guest, .header-guest-item').forEach(el=>el.classList.toggle('is-hidden',on));
      document.querySelectorAll('.header-user, .header-user-item').forEach(el=>el.classList.toggle('is-hidden',!on));
    }
    const go=(url)=>window.location.href=url;

    document.addEventListener('click', async (e)=>{
      const a=e.target.closest('[data-nav]'); if(!a) return;
      e.preventDefault();
      const k=a.getAttribute('data-nav');
      if(k==='login') return go('/login_01.html');
      if(k==='register') return go('/register_01.html');
      if(k==='logout'){ localStorage.removeItem('accessToken'); renderHeaderByAuth(); return go('/'); }
      if(k==='mypage') return isLoggedIn()?go('/mypage_main.html'):go('/login_01.html');
      if(!isLoggedIn()) return go('/login_01.html');
      switch(k){
        case 'record':  return go('/emotion_select_01.html');
        case 'calendar':return go('/emotion_calendar.html');
        case 'map':     return go('/emotion_map.html');
        case 'memory':  return go('/emotion_memory.html');
        case 'around':  return go('/emotion_arround_bluetooth.html');
      }
    });

    /* ========= 드래프트/프리뷰 ========= */
    const qs = new URLSearchParams(location.search);
    const draftId = qs.get('draftId');

    const emojiPreviewTop    = document.getElementById('emojiPreviewTop');
    const emojiPreviewBottom = document.getElementById('emojiPreviewBottom');
    const contentEl          = document.getElementById('content');
    const prevBtn            = document.getElementById('prevBtn');
    const nextBtn            = document.getElementById('nextBtn');

    const fileInputs = [1,2,3,4].map(i => document.getElementById('file'+i));
    const thumbs     = [1,2,3,4].map(i => document.getElementById('thumb'+i));
    const hints      = [1,2,3,4].map(i => document.getElementById('hint'+i));

    // emotion_type → 파일 프리픽스
    const PREFIX_BY_EMO = { joy:'happy', sadness:'sad', anger:'angry', worry:'uneasy', proud:'envious', upset:'upset' };
    // expression_type(emoji01~06) → 번호(02~07)
    const INDEX_BY_CODE = { emoji01:'02', emoji02:'03', emoji03:'04', emoji04:'05', emoji05:'06', emoji06:'07' };

    function resolveImg(emotion_type, expression_type){
      const prefix = PREFIX_BY_EMO[emotion_type];
      const idx = INDEX_BY_CODE[expression_type];
      if (!prefix || !idx) return '';
      return `./asset/images/icon_${prefix}_${idx}.png`;
    }

    function getLocalTempDraft(){
      try{ return JSON.parse(localStorage.getItem('recordDraft.temp')||'null'); }catch(e){ return null; }
    }
    function saveLocalTemp(updates){
      const cur = getLocalTempDraft() || {};
      localStorage.setItem('recordDraft.temp', JSON.stringify({...cur, ...updates, ts: Date.now()}));
    }
    async function fetchServerDraft(id){
      if(!isLoggedIn()||!id) return null;
      try{
        const r = await fetch(`/api/record-drafts/drafts/${encodeURIComponent(id)}`, {
          headers:{'Authorization': authHeader()}
        });
        if(!r.ok) return null;
        return await r.json();
      }catch(e){ return null; }
    }
    async function patchServerDraft(id, payload){
      if(!isLoggedIn()||!id) return false;
      try{
        const r = await fetch(`/api/record-drafts/drafts/${encodeURIComponent(id)}`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json','Authorization': authHeader()},
          body: JSON.stringify(payload)
        });
        return r.ok;
      }catch(e){ return false; }
    }

    // ===== 이미지 업로드 =====
    // 업로드된 S3 URL들을 보관 (인덱스 = 슬롯-1)
    let uploadedImages = [null, null, null, null];

    function refreshThumb(slot, url){
      const img = thumbs[slot];
      if (url) {
        img.src = url;
        img.classList.remove('empty');
      } else {
        img.src = '';
        img.classList.add('empty');
      }
    }
    function setHint(slot, msg){ hints[slot].textContent = msg || ''; }

    async function uploadOneFile(slot, file){
      if (!draftId) { setHint(slot, '드래프트 ID가 없어 업로드할 수 없어요.'); return; }
      if (!file) { return; }
      // 간단한 제한 (백엔드에서 최종 검증)
      const MAX_MB = 15;
      if (file.size > MAX_MB*1024*1024){ setHint(slot, `파일이 ${MAX_MB}MB를 초과합니다.`); return; }

      setHint(slot, '업로드 중...');
      try{
        const fd = new FormData();
        fd.append('file', file);

        const res = await fetch(`/api/record-drafts/drafts/${encodeURIComponent(draftId)}/images`, {
          method: 'POST',
          headers: { 'Authorization': authHeader() },
          body: fd
        });
        if (!res.ok){
          setHint(slot, '업로드 실패');
          return;
        }
        const data = await res.json(); // { url }
        const url = data?.url;
        if (!url){ setHint(slot, 'URL 없음'); return; }

        uploadedImages[slot] = url;
        refreshThumb(slot, url);
        setHint(slot, '업로드 완료');

        // 대표 이미지 = 첫 번째 존재하는 이미지
        const representative = uploadedImages.find(Boolean) || null;

        // 서버에 images & 대표 img 반영
        const ok = await patchServerDraft(draftId, {
          images: uploadedImages.filter(Boolean),
          img: representative
        });
        if (!ok){
          // 서버 PATCH 실패 시에도 로컬 캐시 유지
          saveLocalTemp({ images: uploadedImages.filter(Boolean), img: representative });
          setHint(slot, '서버 반영 실패(로컬 임시 저장)');
        } else {
          // 로컬에도 동기화
          saveLocalTemp({ images: uploadedImages.filter(Boolean), img: representative });
          // 프리뷰 대표 이미지도 교체(UX)
          if (representative){
            emojiPreviewTop.src = representative;
            emojiPreviewBottom.src = representative;
          }
        }
      }catch(err){
        console.error(err);
        setHint(slot, '업로드 오류');
      }
    }

    function bindFileInputs(){
      fileInputs.forEach((input, i)=>{
        input.addEventListener('change', async ()=>{
          const file = input.files && input.files[0];
          // 비운 경우
          if (!file){
            uploadedImages[i] = null;
            refreshThumb(i, null);
            setHint(i, '');
            // 남은 이미지로 대표 갱신
            const representative = uploadedImages.find(Boolean) || (getLocalTempDraft()?.img || null);
            await patchServerDraft(draftId, { images: uploadedImages.filter(Boolean), img: representative });
            saveLocalTemp({ images: uploadedImages.filter(Boolean), img: representative });
            if (representative){
              emojiPreviewTop.src = representative;
              emojiPreviewBottom.src = representative;
            }
            return;
          }
          // 새 업로드
          await uploadOneFile(i, file);
        });
      });
    }

    // 프리뷰 반영 (img 없으면 emotion_type+expression_type로 유추)
    function applyPreview({emotion_type, expression_type, img, content}){
      let derived = img;
      if (!derived) derived = resolveImg(emotion_type, expression_type);
      if (derived){
        emojiPreviewTop.src = derived;
        emojiPreviewBottom.src = derived;
        saveLocalTemp({ img: derived, emotion_type, expression_type });
      }
      if (typeof content === 'string') contentEl.value = content || '';
    }

    async function init(){
      renderHeaderByAuth();

      // 서버 → 로컬 폴백
      let data = null;
      if (draftId) data = await fetchServerDraft(draftId);
      if (!data)  data = getLocalTempDraft();

      // 로컬 병합
      const local = getLocalTempDraft() || {};
      data = { ...(data||{}), ...(local||{}) };

      // 기존 업로드 이미지 있으면 반영
      if (Array.isArray(data.images) && data.images.length){
        uploadedImages = [null,null,null,null];
        data.images.slice(0,4).forEach((url, idx)=>{
          uploadedImages[idx] = url;
          refreshThumb(idx, url);
          setHint(idx, '이미 업로드됨');
        });
      }

      applyPreview({
        emotion_type: data?.emotion_type,
        expression_type: data?.expression_type,
        img: data?.img,
        content: data?.content
      });

      bindFileInputs();

      // 이전
      prevBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        const from = localStorage.getItem('recordDraft.fromPage') || '/emotion_select_02.html';
        let back = from;
        if (draftId) {
          const u = new URL(back, location.origin);
          u.searchParams.set('draftId', draftId);
          back = u.pathname + u.search;
        }
        go(back);
      });

      // 다음 (이모지/텍스트/이미지 상태 함께 유지)
      nextBtn.addEventListener('click', async (e)=>{
        e.preventDefault();

        const cur = getLocalTempDraft() || {};
        const representative = uploadedImages.find(Boolean) || cur.img || null;

        const payload = {
          content: contentEl.value || '',
          emotion_type: cur.emotion_type || data?.emotion_type || null,
          expression_type: cur.expression_type || data?.expression_type || null,
          img: representative,
          images: uploadedImages.filter(Boolean)
        };

        let ok = false;
        if (draftId) ok = await patchServerDraft(draftId, payload);
        if (!ok) saveLocalTemp(payload);

        let url = '/emotion_location.html';
        if (draftId) url += `?draftId=${encodeURIComponent(draftId)}`;
        go(url);
      });
    }

    init();
  </script>
</body>
</html>
