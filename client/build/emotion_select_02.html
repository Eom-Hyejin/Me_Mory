<!DOCTYPE HTML>
<html lang="ko">
<head>
  <title>Memory</title>
  <meta charset="UTF-8">
  <meta name="keywords" content="">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="generator" content="">
  <meta name="robots" content="">
  <meta property="og:type" content="">
  <meta property="og:title" content="">
  <meta property="og:url" content="">
  <meta property="og:description" content="">
  <!--모바일크롬 툴바 컬러-->
  <meta name="theme-color" content="#162060" />
  <!-- 공유 이미지 -->
  <meta property="og:image" content="./asset/images/layout/img_thumbnail.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">  
  <meta content="text/html; charset=UTF-8; X-Content-Type-Options=nosniff" http-equiv="Content-Type">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
  <!-- 파비콘 이미지 -->
  <link href="" rel="icon" type="image/jpg">
  <link href="" rel="shortcut icon" type="image/jpg">
  <link href="" rel="apple-touch-icon" type="image/jpg">				
  <link rel="stylesheet" type="text/css" href="./asset/css/swiper.min.css"> 
  <link rel="stylesheet" type="text/css" href="./asset/css/base.css"> 
  <link rel="stylesheet" type="text/css" href="./asset/css/grid.css?a=2"> 
  <link rel="stylesheet" type="text/css" href="./asset/css/common.css?a=2"> 
  <link rel="stylesheet" type="text/css" href="./asset/css/layout.css"> 
  <script src="./asset/js/jquery-3.3.1.js"></script>
  <script src="./asset/js/swiper.min.js"></script>	
  <script src="./asset/js/common.js?a=1"></script>
  <style>
    .is-hidden{display:none!important}
    .btn[disabled]{opacity:.5; pointer-events:none}
    #nickname { font-family: inherit; font-weight: inherit; }
  </style>
</head>
<body>
  <!-- 헤더 -->
  <header>
    <div class="container">
      <div class="header-logo">
        <h1><a href="/"><img src="./asset/images/logo.png" alt="Memory"/></a></h1>
      </div>
      <div class="header-cate">
        <ul>
          <li class="active"><a href="#" data-nav="record">감정기록</a></li>
          <li><a href="#" data-nav="calendar">감정캘린더</a></li>
          <li><a href="#" data-nav="around">내 주변 감정</a></li>
          <li><a href="#" data-nav="map">감정지도</a></li>
          <li><a href="#" data-nav="memory">감정회고</a></li>
        </ul>
      </div>
      <div class="header-right">
        <!-- 게스트용 -->
        <div class="right-button header-guest">
          <ul>
            <li class="border"><a href="#" data-nav="login">로그인</a></li>
            <li><a href="#" data-nav="register">회원가입</a></li>
          </ul>
        </div>
        <!-- 로그인용 -->
        <div class="right-button header-user is-hidden">
          <ul>
            <li class="border"><a href="#" data-nav="mypage">마이페이지</a></li>
            <li><a href="#" data-nav="logout">로그아웃</a></li>
          </ul>
        </div>
        <div class="right-menu">
          <button type="button" class="menu" onclick="activeParent(this, 'right-menu');">메뉴바</button>
          <div class="inner">
            <ul>
              <li><a href="#" data-nav="record">감정기록</a></li>
              <li><a href="#" data-nav="calendar">감정캘린더</a></li>
              <li><a href="#" data-nav="around">내 주변 감정</a></li>
              <li><a href="#" data-nav="map">감정지도</a></li>
              <li><a href="#" data-nav="memory">감정회고</a></li>
              <!-- 로그인 상태 -->
              <li class="header-user-item is-hidden"><a href="#" data-nav="mypage">마이페이지</a></li>
              <li class="header-user-item is-hidden ye"><a href="#" data-nav="logout">로그아웃</a></li>
              <!-- 게스트 상태 -->
              <li class="header-guest-item"><a href="#" data-nav="login">로그인</a></li>
              <li class="header-guest-item"><a href="#" data-nav="register">회원가입</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- 본문 -->
  <section class="py-lg-0">
    <div class="full-box">
      <div class="full-inner full-height">
        <div class="circle-box cate-01">
          <div class="circle-inner">
            <div class="circle-head">
              <div class="step-box step-02">
                <div class="bar"></div>
              </div>
            </div>
            <div class="circle-body">
              <div class="circle-title">
                <div class="inner">
                  <div class="emotion-result-box">
                    <!-- 기본 프리뷰(행복 기본) → 선택 시 갱신 -->
                    <div class="result"><img id="previewImg" src="./asset/images/icon_happy_01.png" alt="preview"/></div>
                  </div>
                  <h2>오늘 감정을 표현하는 <br class="is-m"/>이모지를 선택해주세요</h2>
                </div>
              </div>

              <!-- 이모지 선택 -->
              <div class="face-check-box emotion">
                <ul id="emojiList">
                  <li class="emotion01">
                    <input type="radio" name="radio" id="radio01" data-img="./asset/images/icon_happy_02.png" data-exp="emoji01"/>
                    <label for="radio01"><div class="spark square"><span class="face"></span></div></label>
                  </li>
                  <li class="emotion02">
                    <input type="radio" name="radio" id="radio02" data-img="./asset/images/icon_happy_03.png" data-exp="emoji02"/>
                    <label for="radio02"><div class="spark square"><span class="face"></span></div></label>
                  </li>
                  <li class="emotion03">
                    <input type="radio" name="radio" id="radio03" data-img="./asset/images/icon_happy_04.png" data-exp="emoji03"/>
                    <label for="radio03"><div class="spark square"><span class="face"></span></div></label>
                  </li>
                  <li class="emotion04">
                    <input type="radio" name="radio" id="radio04" data-img="./asset/images/icon_happy_05.png" data-exp="emoji04"/>
                    <label for="radio04"><div class="spark square"><span class="face"></span></div></label>
                  </li>
                  <li class="emotion05">
                    <input type="radio" name="radio" id="radio05" data-img="./asset/images/icon_happy_06.png" data-exp="emoji05"/>
                    <label for="radio05"><div class="spark square"><span class="face"></span></div></label>
                  </li>
                  <li class="emotion06">
                    <input type="radio" name="radio" id="radio06" data-img="./asset/images/icon_happy_07.png" data-exp="emoji06"/>
                    <label for="radio06"><div class="spark square"><span class="face"></span></div></label>
                  </li>
                </ul>
              </div>
            </div>

            <div class="circle-foot">
              <div class="button-box">
                <a id="prevBtn" href="#" class="btn btn-active-outline w100 flex-0 mr12 mr-lg-8">이전 단계</a>
                <a id="nextBtn" href="#" class="btn btn-active flex-1" aria-disabled="true" disabled>다음</a>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="bg-box">
    <img src="./asset/images/bg_body_cate_02.png" class="is-pc" alt="">
    <img src="./asset/images/bg_body_cate_02_m.png" class="is-m" alt="">
  </div>

  <script src="./asset/js/swiper.js?a=1"></script>
  <script src="/asset/js/app.js?ver=11"></script>
  <script>
    /* ========= 공통 유틸 (토큰/닉네임/헤더) ========= */
    const getToken = () => localStorage.getItem('accessToken') || '';
    const isLoggedIn = () => !!getToken();
    function b64urlToUtf8(b64url){let b64=b64url.replace(/-/g,'+').replace(/_/g,'/');const pad=b64.length%4;if(pad)b64+='='.repeat(4-pad);const bin=atob(b64);const bytes=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);return new TextDecoder('utf-8').decode(bytes);}
    function parseJwtName(tokenRaw){try{const t=tokenRaw.startsWith('Bearer ')?tokenRaw.slice(7).trim():tokenRaw.trim();const p=b64urlToUtf8(t.split('.')[1]);const d=JSON.parse(p);return d.name||d.nickname||d.userName||d.username||'';}catch(e){return''}}
    function setNickname(){const n=isLoggedIn()?(parseJwtName(getToken())||'메모리'):'메모리';/* 이 페이지 타이틀에 별도 닉네임 노출 X */ }
    function renderHeaderByAuth(){const on=isLoggedIn();document.querySelectorAll('.header-guest, .header-guest-item').forEach(el=>el.classList.toggle('is-hidden',on));document.querySelectorAll('.header-user, .header-user-item').forEach(el=>el.classList.toggle('is-hidden',!on));}
    async function hasBleConsent(){const t=getToken();if(!t) return false;try{const r=await fetch('/api/bluetooth/consent',{headers:{'Authorization':t}});if(!r.ok) return false;const d=await r.json();return !!(d&&(d.enabled===1||d.enabled===true));}catch(e){return false}}
    const go=(url)=>window.location.href=url;

    document.addEventListener('click', async (e)=>{
      const a=e.target.closest('[data-nav]'); if(!a) return;
      e.preventDefault();
      const k=a.getAttribute('data-nav');
      if(k==='login') return go('/login_01.html');
      if(k==='register') return go('/register_01.html');
      if(k==='logout'){ localStorage.removeItem('accessToken'); renderHeaderByAuth(); return go('/'); }
      if(k==='mypage') return isLoggedIn()?go('/mypage_main.html'):go('/login_01.html');
      if(!isLoggedIn()) return go('/login_01.html');
      switch(k){
        case 'record': return go('/emotion_select_01.html');
        case 'calendar': return go('/emotion_calendar.html');
        case 'map': return go('/emotion_map.html');
        case 'memory': return go('/emotion_memory.html');
        case 'around': { const ok=await hasBleConsent(); return go(ok?'/emotion_arround_check_01.html':'/emotion_arround_bluetooth.html'); }
      }
    });

    /* ========= 드래프트 핸들링 ========= */
    function getQueryDraftId(){
      const p=new URLSearchParams(location.search);
      return p.get('draftId');
    }
    let draftId = getQueryDraftId(); // page1에서 전달된 값 기대

    function getLocalTempDraft(){
      try{ return JSON.parse(localStorage.getItem('recordDraft.temp')||'null'); }catch(e){ return null; }
    }

    // ✅ PATCH 경로 서버 라우터에 맞게 수정 (/record-drafts/drafts/:id)
    async function updateDraftOnServer(payload){
      if(!isLoggedIn() || !draftId) return false;
      try{
        const res = await fetch(`/api/record-drafts/drafts/${encodeURIComponent(draftId)}`, {
          method: 'PATCH',
          headers: {'Content-Type':'application/json','Authorization':getToken()},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('patch failed');
        return true;
      }catch(e){ return false; }
    }

    // 서버 드래프트(있으면) 가져오기
    async function fetchServerDraft(){
      if(!isLoggedIn() || !draftId) return null;
      try{
        const res = await fetch(`/api/record-drafts/drafts/${encodeURIComponent(draftId)}`, {
          headers:{'Authorization':getToken()}
        });
        if(!res.ok) return null;
        return await res.json();
      }catch(e){ return null; }
    }

    function mergeLocalTempDraft(updates){
      const cur = getLocalTempDraft() || {};
      localStorage.setItem('recordDraft.temp', JSON.stringify({...cur, ...updates, ts: Date.now()}));
    }

    /* ========= 이모지 선택 로직 ========= */
    const previewImg = document.getElementById('previewImg');
    const emojiList = document.getElementById('emojiList');
    const nextBtn   = document.getElementById('nextBtn');
    const prevBtn   = document.getElementById('prevBtn');

    let selectedExp = '';      // expression_type (emoji01 ~ emoji06)
    let selectedImg = '';      // 선택된 프리뷰 이미지 경로

    // 라디오 변경 이벤트(라벨 클릭 포함 안정 처리)
    emojiList.addEventListener('change', async (e)=>{
      const input = e.target.closest('input[type="radio"][data-exp]');
      if(!input) return;
      selectedExp = input.getAttribute('data-exp');
      selectedImg = input.getAttribute('data-img');
      if(selectedImg) previewImg.src = selectedImg;

      const payload = { expression_type: selectedExp, img: selectedImg };
      const ok = await updateDraftOnServer(payload);
      if(!ok) mergeLocalTempDraft(payload);

      nextBtn.removeAttribute('disabled');
      nextBtn.setAttribute('aria-disabled','false');
    });

    // 초기 상태 복원: 서버 > 로컬 폴백
    async function hydrateFromDraft(){
      // 1) 서버 시도
      let draft = await fetchServerDraft();
      // 2) 없으면 로컬 폴백
      if(!draft){
        draft = getLocalTempDraft();
      }
      if(!draft) return;

      // 이미지/이모지 반영
      if(draft.img){
        previewImg.src = draft.img;
        selectedImg = draft.img;
      }
      if(draft.expression_type){
        selectedExp = draft.expression_type;
      }

      // 해당 라디오 체크 (expression_type 또는 img 매칭)
      const radios = emojiList.querySelectorAll('input[type="radio"][data-exp]');
      let matched = false;
      radios.forEach(r=>{
        const byExp = selectedExp && r.getAttribute('data-exp') === selectedExp;
        const byImg = selectedImg && r.getAttribute('data-img') === selectedImg;
        if(byExp || byImg){
          r.checked = true;
          matched = true;
        }
      });

      if(matched){
        nextBtn.removeAttribute('disabled');
        nextBtn.setAttribute('aria-disabled','false');
      }
    }

    /* ========= 네비게이션 ========= */
    prevBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const backUrl = draftId ? `/emotion_select_01.html?draftId=${encodeURIComponent(draftId)}` : '/emotion_select_01.html';
      go(backUrl);
    });

    nextBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      if(!selectedExp) return;
      let url = '/emotion_text.html';
      if(draftId) url += `?draftId=${encodeURIComponent(draftId)}`;
      go(url);
    });

    /* ========= 초기화 ========= */
    renderHeaderByAuth();
    setNickname();
    hydrateFromDraft();
    window.addEventListener('storage',(ev)=>{ if(ev.key==='accessToken'){ renderHeaderByAuth(); setNickname(); }});
  </script>
</body>
</html>