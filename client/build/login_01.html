<!DOCTYPE HTML>
<html lang="ko">
<head>
  <title>Memory</title>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="text/html; charset=UTF-8; X-Content-Type-Options=nosniff" http-equiv="Content-Type">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
  <meta name="theme-color" content="#162060" />
  <meta property="og:image" content="./asset/images/layout/img_thumbnail.png">

  <link rel="stylesheet" type="text/css" href="./asset/css/swiper.min.css">
  <link rel="stylesheet" type="text/css" href="./asset/css/base.css">
  <link rel="stylesheet" type="text/css" href="./asset/css/grid.css?a=2">
  <link rel="stylesheet" type="text/css" href="./asset/css/common.css?a=1">
  <link rel="stylesheet" type="text/css" href="./asset/css/layout.css">

  <script src="./asset/js/jquery-3.3.1.js"></script>
  <script src="./asset/js/swiper.min.js"></script>
  <script src="./asset/js/common.js?a=2"></script>
  <style>.is-hidden{display:none!important}</style>
</head>
<body>
  <!-- Header (index.html과 동일한 구조/동작) -->
  <header>
    <div class="container">
      <div class="header-logo">
        <h1><a href="/"><img src="./asset/images/logo.png" alt="Memory"/></a></h1>
      </div>

      <div class="header-cate">
        <ul>
          <li><a href="#" data-nav="record">감정기록</a></li>
          <li><a href="#" data-nav="calendar">감정캘린더</a></li>
          <li><a href="#" data-nav="around">내 주변 감정</a></li>
          <li><a href="#" data-nav="map">감정지도</a></li>
          <li><a href="#" data-nav="memory">감정회고</a></li>
        </ul>
      </div>

      <div class="header-right">
        <!-- 게스트용 -->
        <div class="right-button header-guest">
          <ul>
            <li class="border"><a href="#" data-nav="login">로그인</a></li>
            <li><a href="#" data-nav="register">회원가입</a></li>
          </ul>
        </div>

        <!-- 로그인용 -->
        <div class="right-button header-user is-hidden">
          <ul>
            <li class="border"><a href="#" data-nav="mypage">마이페이지</a></li>
            <li><a href="#" data-nav="logout">로그아웃</a></li>
          </ul>
        </div>

        <div class="right-menu">
          <button type="button" class="menu" onclick="activeParent(this, 'right-menu');">메뉴바</button>
          <div class="inner">
            <ul>
              <li><a href="#" data-nav="record">감정기록</a></li>
              <li><a href="#" data-nav="calendar">감정캘린더</a></li>
              <li><a href="#" data-nav="around">내 주변 감정</a></li>
              <li><a href="#" data-nav="map">감정지도</a></li>
              <li><a href="#" data-nav="memory">감정회고</a></li>

              <!-- 로그인 상태 -->
              <li class="header-user-item is-hidden"><a href="#" data-nav="mypage">마이페이지</a></li>
              <li class="header-user-item is-hidden ye"><a href="#" data-nav="logout">로그아웃</a></li>

              <!-- 게스트 상태 -->
              <li class="header-guest-item"><a href="#" data-nav="login">로그인</a></li>
              <li class="header-guest-item"><a href="#" data-nav="register">회원가입</a></li>
            </ul>
          </div>
        </div>
      </div>

    </div>
  </header>

  <!-- Body (로그인 선택 영역) -->
  <section>
    <div class="full-box">
      <div class="full-inner full-height">
        <div class="container container-sm">
          <div class="logo-box">
            <h2><img src="./asset/images/logo.png" alt="Memory"/></h2>
            <p class="su">나의 감정 우주로 떠나는 타임캡슐 여행</p>
            <img src="./asset/images/img_logo_face.png" class="face" alt="">
          </div>

          <div class="container container-xs px-lg-0 mt95 mt-lg-70">
            <div class="button-box">
              <a href="/api/auth/kakao" class="btn btn-kakao">카카오톡으로 로그인</a>
            </div>
            <div class="button-box mt16 mt-lg-12">
              <a href="/api/auth/naver" class="btn btn-naver">네이버로 로그인</a>
            </div>
            <div class="button-box mt16 mt-lg-12">
              <a href="/login_02.html" class="btn btn-active">아이디로 로그인</a>
            </div>
            <div class="flex flex-vc flex-tc mt16 mt-lg-12">
              <a href="/register_01.html" class="ft-white t-under f-lg-12">회원가입</a>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <div class="bg-box">
    <img src="./asset/images/bg_body_login.png" class="is-pc" alt="">
    <img src="./asset/images/bg_body_login_m.png" class="is-m" alt="">
  </div>

  <script src="./asset/js/swiper.js?a=1"></script>
  <script src="/asset/js/app.js?ver=21"></script>

  <!-- nav/헤더 토글 스크립트 (index.html과 동일 로직) -->
  <script>
    // 로그인 여부
    const isLoggedIn = () => !!localStorage.getItem('accessToken');

    // BLE 동의 조회
    async function hasBleConsent() {
      const token = localStorage.getItem('accessToken');
      if (!token) return false;
      try {
        const res = await fetch('/api/bluetooth/consent', { headers: { 'Authorization': token } });
        if (!res.ok) return false;
        const data = await res.json();
        return !!(data && (data.enabled === 1 || data.enabled === true));
      } catch (e) { return false; }
    }

    const go = (url) => window.location.href = url;

    // 헤더 토글
    function renderHeaderByAuth() {
      const loggedIn = isLoggedIn();
      document.querySelectorAll('.header-guest, .header-guest-item')
        .forEach(el => el.classList.toggle('is-hidden', loggedIn));
      document.querySelectorAll('.header-user, .header-user-item')
        .forEach(el => el.classList.toggle('is-hidden', !loggedIn));
    }

    // 네비 처리
    document.addEventListener('click', async (e) => {
      const a = e.target.closest('[data-nav]');
      if (!a) return;
      e.preventDefault();
      const key = a.getAttribute('data-nav');

      if (key === 'login')    return go('/login_01.html');
      if (key === 'register') return go('/register_01.html');
      if (key === 'logout')   {
        localStorage.removeItem('accessToken');
        renderHeaderByAuth();
        return go('/');
      }
      if (key === 'mypage')   return isLoggedIn() ? go('/mypage_main.html') : go('/login_01.html');

      if (!isLoggedIn()) return go('/login_01.html');

      switch (key) {
        case 'record':   return go('/emotion_select_01.html');
        case 'calendar': return go('/emotion_calendar.html');
        case 'map':      return go('/emotion_map.html');
        case 'memory':   return go('/emotion_memory.html');
        case 'around': {
          const ok = await hasBleConsent();
          return go(ok ? '/emotion_arround_check_01.html' : '/emotion_arround_bluetooth.html');
        }
      }
    });

    // 초기 렌더 + 다른 탭에서 로그인 상태 변경 반영
    renderHeaderByAuth();
    window.addEventListener('storage', (ev) => {
      if (ev.key === 'accessToken') renderHeaderByAuth();
    });
  </script>
</body>
</html>