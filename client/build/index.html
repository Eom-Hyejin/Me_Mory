<!DOCTYPE HTML>
<html lang="ko">
<head>
  <title>Memory</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
  <link rel="stylesheet" type="text/css" href="./asset/css/swiper.min.css">
  <link rel="stylesheet" type="text/css" href="./asset/css/base.css">
  <link rel="stylesheet" type="text/css" href="./asset/css/grid.css?a=2">
  <link rel="stylesheet" type="text/css" href="./asset/css/common.css?a=1">
  <link rel="stylesheet" type="text/css" href="./asset/css/layout.css">
  <script src="./asset/js/jquery-3.3.1.js"></script>
  <script src="./asset/js/swiper.min.js"></script>
  <script src="./asset/js/common.js?a=2"></script>

  <!-- 보강 스타일 -->
  <style>
    .is-hidden { display:none!important }

    /* 공통 로그아웃 버튼 스타일 */
    header .right-button .header-user a[data-nav="logout"],
    header .right-menu .inner ul li a[data-nav="logout"] {
      background-color: #ffcc00 !important; /* 노란 배경 */
      color: #fff !important;               /* 흰 글자 */
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: bold;
      display: block;          /* block으로 바꿔줘야 margin-left: auto 가능 */
      width: fit-content;      /* 글자 크기만큼만 */
      margin-left: auto;       /* 오른쪽 정렬 */
      text-align: center;
    }

    /* hover/focus 상태 */
    header a[data-nav="logout"]:hover,
    header a[data-nav="logout"]:focus {
      filter: brightness(0.9);
    }
  </style>
</head>
<body>
<header>
  <div class="container">
    <div class="header-logo">
      <h1><a href="/"><img src="./asset/images/logo.png" alt="Memory"/></a></h1>
    </div>

    <div class="header-cate">
      <ul>
        <li><a href="#" data-nav="record">감정기록</a></li>
        <li><a href="#" data-nav="calendar">감정캘린더</a></li>
        <li><a href="#" data-nav="around">내 주변 감정</a></li>
        <li><a href="#" data-nav="map">감정지도</a></li>
        <li><a href="#" data-nav="memory">감정회고</a></li>
      </ul>
    </div>

    <div class="header-right">
      <!-- 게스트 -->
      <div class="right-button header-guest">
        <ul>
          <li class="border"><a href="#" data-nav="login">로그인</a></li>
          <li><a href="#" data-nav="register">회원가입</a></li>
        </ul>
      </div>

      <!-- 로그인 -->
      <div class="right-button header-user is-hidden">
        <ul>
          <li class="border"><a href="#" data-nav="mypage">마이페이지</a></li>
          <li><a href="#" data-nav="logout">로그아웃</a></li>
        </ul>
      </div>

      <div class="right-menu">
        <button type="button" class="menu" onclick="activeParent(this, 'right-menu');">메뉴바</button>
        <div class="inner">
          <ul>
            <li><a href="#" data-nav="record">감정기록</a></li>
            <li><a href="#" data-nav="calendar">감정캘린더</a></li>
            <li><a href="#" data-nav="around">내 주변 감정</a></li>
            <li><a href="#" data-nav="map">감정지도</a></li>
            <li><a href="#" data-nav="memory">감정회고</a></li>

            <!-- 로그인 상태 -->
            <li class="header-user-item is-hidden"><a href="#" data-nav="mypage">마이페이지</a></li>
            <li class="header-user-item is-hidden ye"><a href="#" data-nav="logout">로그아웃</a></li>

            <!-- 게스트 상태 -->
            <li class="header-guest-item"><a href="#" data-nav="login">로그인</a></li>
            <li class="header-guest-item"><a href="#" data-nav="register">회원가입</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<section>
  <div class="full-box">
    <div class="full-inner full-height">
      <div class="container container-sm">
        <div class="logo-box">
          <h2><img src="./asset/images/logo.png" alt="Memory"/></h2>
          <p class="su">나의 감정 우주로 떠나는 타임캡슐 여행</p>
        </div>
        <div class="face-box">
          <img src="./asset/images/img_face_all.png" class="lg" alt="faces"/>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="bg-box">
  <img src="./asset/images/bg_body_login.png" class="is-pc" alt="">
  <img src="./asset/images/bg_body_login_m.png" class="is-m" alt="">
</div>

<script>
  const isLoggedIn = () => !!localStorage.getItem('accessToken');

  async function hasBleConsent() {
    const token = localStorage.getItem('accessToken');
    if (!token) return false;
    try {
      const res = await fetch('/api/bluetooth/consent', { headers: { 'Authorization': token } });
      if (!res.ok) return false;
      const data = await res.json();
      return !!(data && (data.enabled === 1 || data.enabled === true));
    } catch (e) { return false; }
  }

  const go = (url) => window.location.href = url;

  function renderHeaderByAuth() {
    const loggedIn = isLoggedIn();
    document.querySelectorAll('.header-guest, .header-guest-item')
      .forEach(el => el.classList.toggle('is-hidden', loggedIn));
    document.querySelectorAll('.header-user, .header-user-item')
      .forEach(el => el.classList.toggle('is-hidden', !loggedIn));
  }

  document.addEventListener('click', async (e) => {
    const a = e.target.closest('[data-nav]');
    if (!a) return;
    e.preventDefault();
    const key = a.getAttribute('data-nav');

    if (key === 'login')    return go('/login_01.html');
    if (key === 'register') return go('/register_01.html');
    if (key === 'logout') {
      localStorage.removeItem('accessToken');
      renderHeaderByAuth();
      return go('/');
    }
    if (key === 'mypage')   return isLoggedIn() ? go('/mypage_main.html') : go('/login_01.html');

    if (!isLoggedIn()) return go('/login_01.html');

    switch (key) {
      case 'record':   return go('/emotion_select_01.html');
      case 'calendar': return go('/emotion_calendar.html');
      case 'map':      return go('/emotion_map.html');
      case 'memory':   return go('/emotion_memory.html');
      case 'around': {
        const ok = await hasBleConsent();
        return go(ok ? '/emotion_arround_check_01.html' : '/emotion_arround_bluetooth.html');
      }
    }
  });

  renderHeaderByAuth();
  window.addEventListener('storage', (ev) => {
    if (ev.key === 'accessToken') renderHeaderByAuth();
  });
</script>
</body>
</html>